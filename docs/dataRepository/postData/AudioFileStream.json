{"title": "AudioFileStream", "date": "2024-03-12 13:42:30", "categories": "\u97f3\u89c6\u9891", "tags": "Audio", "keywords": "AudioFileStream,Audio File Stream Services,\u97f3\u9891\u6d41\u64ad\u653e", "description": "", "images": "", "file_name": "AudioFileStream", "short": " \u6982\u8ff0 \n \n Audio File Stream Services provides the interface for parsing streamed audio files\u2014in which only a limited window of data is available at a time. \n\u97f3\u9891\u6587\u4ef6\u6d41\u670d\u52a1\u63d0\u4f9b\u4e86\u7528\u4e8e\u89e3\u6790\u6d41\u5f0f\u97f3\u9891\u6587\u4ef6\u7684\u63a5\u53e3, \u5176\u4e2d\u4e00\u6b21\u53ea\u80fd\u4f7f\u7528\u6709\u9650\u7684\u6570\u636e\u7a97\u53e3.  \n \n ", "content": "<h2 id=\"_1\">\u6982\u8ff0</h2>\n<blockquote>\n<p>Audio File Stream Services provides the interface for parsing streamed audio files\u2014in which only a limited window of data is available at a time.<br />\n\u97f3\u9891\u6587\u4ef6\u6d41\u670d\u52a1\u63d0\u4f9b\u4e86\u7528\u4e8e\u89e3\u6790\u6d41\u5f0f\u97f3\u9891\u6587\u4ef6\u7684\u63a5\u53e3, \u5176\u4e2d\u4e00\u6b21\u53ea\u80fd\u4f7f\u7528\u6709\u9650\u7684\u6570\u636e\u7a97\u53e3. </p>\n</blockquote>\n<!-- more -->\n\n<blockquote>\n<p>Audio file streams, by nature, are not random access. When you request data from a stream, earlier data might no longer be accessible and later data might not yet be available. In addition, the data you obtain (and then provide to a parser) might include partial packets. To parse streamed audio data, then, a parser must remember data from partially satisfied requests, and must be able to wait for the remainder of that data. In other words, a parser must be able to suspend parsing as needed and then resume where it left off.<br />\n\u97f3\u9891\u6587\u4ef6\u6d41\u672c\u8d28\u4e0a\u4e0d\u662f\u968f\u673a\u8bbf\u95ee\u7684. \u5f53\u60a8\u4ece\u6d41\u8bf7\u6c42\u6570\u636e\u65f6, \u8f83\u65e9\u7684\u6570\u636e\u53ef\u80fd\u65e0\u6cd5\u518d\u8bbf\u95ee, \u800c\u8f83\u665a\u7684\u6570\u636e\u53ef\u80fd\u5c1a\u4e0d\u53ef\u7528. \u6b64\u5916, \u60a8\u83b7\u53d6\u7684\u6570\u636e\uff08\u7136\u540e\u63d0\u4f9b\u7ed9\u89e3\u6790\u5668\uff09\u53ef\u80fd\u5305\u62ec\u90e8\u5206\u6570\u636e\u5305. \u4e3a\u4e86\u89e3\u6790\u6d41\u5f0f\u97f3\u9891\u6570\u636e, \u89e3\u6790\u5668\u5fc5\u987b\u8bb0\u4f4f\u90e8\u5206\u6ee1\u8db3\u7684\u8bf7\u6c42\u4e2d\u7684\u6570\u636e, \u5e76\u4e14\u5fc5\u987b\u80fd\u591f\u7b49\u5f85\u8be5\u6570\u636e\u7684\u5176\u4f59\u90e8\u5206. \u6362\u53e5\u8bdd\u8bf4, \u89e3\u6790\u5668\u5fc5\u987b\u80fd\u591f\u6839\u636e\u9700\u8981\u6682\u505c\u89e3\u6790, \u7136\u540e\u4ece\u4e2d\u65ad\u5904\u6062\u590d. </p>\n<p>To use a parser, you pass data from a streamed audio file, as you acquire it, to the parser. When the parser has a complete packet of audio data or a complete property, it invokes a callback function. Your callbacks then process the parsed data\u2014such as by playing it or writing it to disk.<br />\n\u8981\u4f7f\u7528\u89e3\u6790\u5668, \u60a8\u53ef\u4ee5\u5728\u83b7\u53d6\u6d41\u5f0f\u97f3\u9891\u6587\u4ef6\u65f6\u5c06\u6570\u636e\u4f20\u9012\u5230\u89e3\u6790\u5668. \u5f53\u89e3\u6790\u5668\u5177\u6709\u5b8c\u6574\u7684\u97f3\u9891\u6570\u636e\u5305\u6216\u5b8c\u6574\u7684\u5c5e\u6027\u65f6, \u5b83\u4f1a\u8c03\u7528\u56de\u8c03\u51fd\u6570. \u7136\u540e, \u60a8\u7684\u56de\u8c03\u4f1a\u5904\u7406\u89e3\u6790\u540e\u7684\u6570\u636e, \u4f8b\u5982\u64ad\u653e\u6570\u636e\u6216\u5c06\u5176\u5199\u5165\u78c1\u76d8. </p>\n</blockquote>\n<p>\u5f15\u7528\u81ea Apple Document: <a href=\"https://developer.apple.com/documentation/audiotoolbox/audio_file_stream_services?language=objc\">Audio File Stream Services</a></p>\n<p>\u603b\u7684\u6765\u8bf4, AudioFileStream \u53ef\u4ee5\u8bfb\u53d6\u97f3\u9891\u6d41\u4e2d\u7684\u97f3\u9891\u4fe1\u606f\u4ee5\u53ca\u5206\u79bb\u97f3\u9891\u5e27, \u5b83\u652f\u6301\u7684\u97f3\u9891\u7c7b\u578b\u6709:</p>\n<ul>\n<li>AIFF</li>\n<li>AIFC</li>\n<li>WAVE</li>\n<li>CAF</li>\n<li>NeXT</li>\n<li>ADTS</li>\n<li>MPEG Audio Layer 3</li>\n<li>AAC</li>\n<li>MPEG-4</li>\n</ul>\n<h2 id=\"audiofilestream\">AudioFileStream \u521d\u59cb\u5316</h2>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"n\">OSStatus</span><span class=\"w\"> </span><span class=\"n\">AudioFileStreamOpen</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">inClientData</span><span class=\"p\">,</span>\n<span class=\"w\">                                     </span><span class=\"n\">AudioFileStream_PropertyListenerProc</span><span class=\"w\"> </span><span class=\"n\">inPropertyListenerProc</span><span class=\"p\">,</span>\n<span class=\"w\">                                     </span><span class=\"n\">AudioFileStream_PacketsProc</span><span class=\"w\"> </span><span class=\"n\">inPacketsProc</span><span class=\"p\">,</span>\n<span class=\"w\">                                     </span><span class=\"n\">AudioFileTypeID</span><span class=\"w\"> </span><span class=\"n\">inFileTypeHint</span><span class=\"p\">,</span>\n<span class=\"w\">                                     </span><span class=\"n\">AudioFileStreamID</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">outAudioFileStream</span><span class=\"p\">)</span>\n</code></pre></div>\n\n<ul>\n<li>\n<p>inClientData: \u4e0a\u4e0b\u6587\u5bf9\u8c61.</p>\n</li>\n<li>\n<p>inPropertyListenerProc: <strong>AudioFileStream_PropertyListenerProc</strong>\u97f3\u9891\u4fe1\u606f\u56de\u8c03\u51fd\u6570, \u6bcf\u6709\u89e3\u6790\u5230\u97f3\u9891\u7684\u4fe1\u606f\u5c31\u4f1a\u56de\u8c03\u4e00\u6b21.</p>\n</li>\n<li>\n<p>inPacketsProc: <strong>AudioFileStream_PacketsProc</strong> \u5206\u79bb\u97f3\u9891\u5e27\u56de\u8c03\u51fd\u6570, \u5728\u89e3\u6790\u5b8c\u6bcf\u6b21\u4f20\u5165\u7684Data\u540e, \u89e6\u53d1\u56de\u8c03.</p>\n</li>\n<li>\n<p>inFileTypeHint: <strong>AudioFileTypeID</strong> \u97f3\u9891\u7c7b\u578b\u5efa\u8bae, AudioFileStream \u4f1a\u6839\u636e\u5f00\u53d1\u8005\u7ed9\u51fa\u7684\u5efa\u8bae\u7c7b\u578b\u89e3\u6790, \u5982\u679c\u4e0d\u786e\u5b9a\u7c7b\u578b\u5c31\u4f20 0.</p>\n</li>\n<li>\n<p>outAudioFileStream: <strong>AudioFileStreamID</strong> AudioFileStream \u5b9e\u4f8b\u6807\u8bc6.</p>\n</li>\n</ul>\n<h3 id=\"audiofiletypeid\">AudioFileTypeID</h3>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">CF_ENUM</span><span class=\"p\">(</span><span class=\"n\">AudioFileTypeID</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileAIFFType</span><span class=\"w\">              </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">AIFF</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileAIFCType</span><span class=\"w\">              </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">AIFC</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileWAVEType</span><span class=\"w\">              </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">WAVE</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileRF64Type</span><span class=\"w\">              </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">RF64</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileBW64Type</span><span class=\"w\">              </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">BW64</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileWave64Type</span><span class=\"w\">            </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">W64f</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileSoundDesigner2Type</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">Sd2f</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileNextType</span><span class=\"w\">              </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">NeXT</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileMP3Type</span><span class=\"w\">               </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">MPG3</span><span class=\"err\">&#39;</span><span class=\"p\">,</span><span class=\"w\">   </span><span class=\"c1\">// mpeg layer 3</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileMP2Type</span><span class=\"w\">               </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">MPG2</span><span class=\"err\">&#39;</span><span class=\"p\">,</span><span class=\"w\">   </span><span class=\"c1\">// mpeg layer 2</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileMP1Type</span><span class=\"w\">               </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">MPG1</span><span class=\"err\">&#39;</span><span class=\"p\">,</span><span class=\"w\">   </span><span class=\"c1\">// mpeg layer 1</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileAC3Type</span><span class=\"w\">               </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">ac</span><span class=\"mi\">-3</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileAAC_ADTSType</span><span class=\"w\">          </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">adts</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileMPEG4Type</span><span class=\"w\">             </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">mp4f</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileM4AType</span><span class=\"w\">               </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">m4af</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileM4BType</span><span class=\"w\">               </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">m4bf</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileCAFType</span><span class=\"w\">               </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">caff</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFile3GPType</span><span class=\"w\">               </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"mi\">3</span><span class=\"n\">gpp</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFile3GP2Type</span><span class=\"w\">              </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"mi\">3</span><span class=\"n\">gp2</span><span class=\"err\">&#39;</span><span class=\"p\">,</span><span class=\"w\">       </span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileAMRType</span><span class=\"w\">               </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">amrf</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileFLACType</span><span class=\"w\">              </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">flac</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">kAudioFileLATMInLOASType</span><span class=\"w\">        </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">loas</span><span class=\"err\">&#39;</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n\n<h2 id=\"_2\">\u89e3\u6790\u97f3\u9891\u6d41\u6570\u636e</h2>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"n\">OSStatus</span><span class=\"w\"> </span><span class=\"nf\">AudioFileStreamParseBytes</span><span class=\"p\">(</span><span class=\"n\">AudioFileStreamID</span><span class=\"w\"> </span><span class=\"n\">inAudioFileStream</span><span class=\"p\">,</span>\n<span class=\"w\">                                          </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">inDataByteSize</span><span class=\"p\">,</span>\n<span class=\"w\">                                          </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">inData</span><span class=\"p\">,</span>\n<span class=\"w\">                                          </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">inFlags</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<ul>\n<li>\n<p>inAudioFileStream: \u4f20\u5165\u521d\u59cb\u5316\u5f97\u5230\u7684 AudioFileStream \u5b9e\u4f8b\u6807\u8bc6.</p>\n</li>\n<li>\n<p>inDataByteSize: \u672c\u6b21\u89e3\u6790\u7684\u6570\u636e\u957f\u5ea6.</p>\n</li>\n<li>\n<p>inData: \u672c\u6b21\u89e3\u6790\u7684\u6570\u636e.</p>\n</li>\n<li>\n<p>inFlags: \u672c\u6b21\u7684\u89e3\u6790\u548c\u4e0a\u4e00\u6b21\u89e3\u6790\u662f\u5426\u662f\u8fde\u7eed\u7684\u5173\u7cfb, \u5982\u679c\u662f\u8fde\u7eed\u7684\u4f20\u51650, \u5426\u5219\u4f20\u5165kAudioFileStreamParseFlag_Discontinuity. \u89e3\u6790\u4ee5\u5e27\u4e3a\u5355\u4f4d, \u89e3\u7801\u524d\u6211\u4eec\u65e0\u6cd5\u5f97\u77e5\u6bcf\u4e2a\u5e27\u5177\u4f53\u6240\u5904\u6587\u4ef6\u6d41\u5b57\u8282\u4f4d\u7f6e, \u56e0\u6b64\u5728\u6309\u5e27\u5355\u4f4d\u89e3\u6790\u5b8c\u540e, \u4f1a\u6709\u6570\u636e\u5269\u4f59, \u5728\u63a5\u6536\u7684\u4e0b\u4e00\u6b21\u8fde\u7eed\u6570\u636e\u540e, \u6211\u4eec\u9700\u8981\u5c06\u4e0a\u6b21\u5269\u4f59\u6570\u636e\u62fc\u63a5\u7ee7\u7eed\u89e3\u6790, \u8fd9\u6837\u624d\u80fd\u4fdd\u8bc1\u5b8c\u6574\u89e3\u6790. \u4f46\u5982 Seek \u64cd\u4f5c, Seek \u540e\u63a5\u6536\u7684\u6570\u636e\u548c\u4e0a\u4e00\u6b21\u5269\u4f59\u6570\u636e\u662f\u4e0d\u8fde\u7eed\u7684, \u6240\u4ee5\u6211\u4eec\u4f20\u5165 kAudioFileStreamParseFlag_Discontinuity \u4e22\u5f03\u6389\u4e0a\u4e00\u6b21\u5269\u4f59\u6570\u636e.</p>\n</li>\n</ul>\n<p><strong>AudioFileStreamParseBytes</strong> \u65b9\u6cd5\u4f1a\u8fd4\u56de OSStatus, \u89e3\u6790\u6210\u529f\u8fd4\u56de noErr, \u4ee5\u4e0b\u662f\u76f8\u5173\u64cd\u4f5c\u7684\u9519\u8bef\u7801:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">CF_ENUM</span><span class=\"p\">(</span><span class=\"n\">OSStatus</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u4e0d\u652f\u6301\u8be5\u6587\u4ef6\u7c7b\u578b</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_UnsupportedFileType</span><span class=\"w\">       </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">typ</span><span class=\"o\">?</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u6b64\u6587\u4ef6\u7c7b\u578b\u4e0d\u652f\u6301\u6570\u636e\u683c\u5f0f</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_UnsupportedDataFormat</span><span class=\"w\">     </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">fmt</span><span class=\"o\">?</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u4e0d\u652f\u6301\u8be5\u5c5e\u6027</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_UnsupportedProperty</span><span class=\"w\">       </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">pty</span><span class=\"o\">?</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u5c5e\u6027\u6570\u636e\u7684\u5927\u5c0f\u4e0d\u6b63\u786e. </span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_BadPropertySize</span><span class=\"w\">           </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"o\">!</span><span class=\"n\">siz</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u7531\u4e8e\u6587\u4ef6\u7684\u6570\u636e\u5305\u8868\u6216\u5176\u4ed6\u5b9a\u4e49, \u4fe1\u606f\u8981\u4e48\u4e0d\u5b58\u5728, \u8981\u4e48\u5728\u97f3\u9891\u6570\u636e\u4e4b\u540e. \u603b\u7684\u6765\u8bf4\u8fd9\u4e2a\u6587\u4ef6\u9700\u8981\u5168\u90e8\u4e0b\u8f7d\u5b8c\u624d\u80fd\u64ad\u653e, \u65e0\u6cd5\u6d41\u64ad. </span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_NotOptimized</span><span class=\"w\">              </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">optm</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u6570\u636e\u5305\u504f\u79fb\u91cf\u5c0f\u4e8e\u96f6\u6216\u8d85\u8fc7\u6587\u4ef6\u672b\u5c3e, \u6216\u8005\u5728\u6784\u5efa\u6570\u636e\u5305\u8868\u65f6\u8bfb\u53d6\u635f\u574f\u7684\u6570\u636e\u5305\u5927\u5c0f. </span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_InvalidPacketOffset</span><span class=\"w\">       </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">pck</span><span class=\"o\">?</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u8be5\u6587\u4ef6\u683c\u5f0f\u4e0d\u6b63\u786e, \u6216\u8005\u4e0d\u662f\u5176\u7c7b\u578b\u7684\u97f3\u9891\u6587\u4ef6\u7684\u6709\u6548\u5b9e\u4f8b, \u6216\u8005\u672a\u88ab\u8bc6\u522b\u4e3a\u97f3\u9891\u6587\u4ef6. </span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_InvalidFile</span><span class=\"w\">               </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">dta</span><span class=\"o\">?</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u5728\u97f3\u9891\u6570\u636e\u4e4b\u524d, \u6b64\u6587\u4ef6\u4e2d\u4e0d\u5b58\u5728\u5c5e\u6027\u503c. </span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_ValueUnknown</span><span class=\"w\">              </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">unk</span><span class=\"o\">?</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u63d0\u4f9b\u7ed9\u5206\u6790\u5668\u7684\u6570\u636e\u91cf\u4e0d\u8db3\u4ee5\u4ea7\u751f\u4efb\u4f55\u7ed3\u679c. </span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_DataUnavailable</span><span class=\"w\">           </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">more</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u8bd5\u56fe\u8fdb\u884c\u975e\u6cd5\u64cd\u4f5c. </span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_IllegalOperation</span><span class=\"w\">          </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">nope</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u53d1\u751f\u4e86\u672a\u6307\u5b9a\u7684\u9519\u8bef. </span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_UnspecifiedError</span><span class=\"w\">          </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">wht</span><span class=\"o\">?</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u4e0d\u8fde\u7eed\u6027\u65e0\u6cd5\u6062\u590d</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamError_DiscontinuityCantRecover</span><span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">&#39;</span><span class=\"n\">dsc</span><span class=\"o\">!</span><span class=\"err\">&#39;</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n\n<h2 id=\"_3\">\u89e3\u6790\u97f3\u9891\u4fe1\u606f</h2>\n<h3 id=\"audiofilestream_propertylistenerproc\">AudioFileStream_PropertyListenerProc</h3>\n<p>\u5728\u8c03\u7528 <strong>AudioFileStreamParseBytes</strong> \u540e, \u9996\u5148\u4f1a\u53bb\u89e3\u6790\u97f3\u9891\u6d41\u4e2d\u7684\u97f3\u9891\u5c5e\u6027\u4fe1\u606f. \u89e3\u6790\u5230\u540e\u89e6\u53d1 <strong>AudioFileStream_PropertyListenerProc</strong> \u56de\u8c03.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">AudioFileStream_PropertyListenerProc</span><span class=\"p\">)(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">inClientData</span><span class=\"p\">,</span>\n<span class=\"w\">                                                     </span><span class=\"n\">AudioFileStreamID</span><span class=\"w\"> </span><span class=\"n\">inAudioFileStream</span><span class=\"p\">,</span>\n<span class=\"w\">                                                     </span><span class=\"n\">AudioFileStreamPropertyID</span><span class=\"w\"> </span><span class=\"n\">inPropertyID</span><span class=\"p\">,</span>\n<span class=\"w\">                                                     </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ioFlags</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<ul>\n<li>inClientData: \u4e0a\u4e0b\u6587\u5bf9\u8c61.</li>\n<li>inAudioFileStream: AudioFileStream \u5b9e\u4f8b\u6807\u8bc6.</li>\n<li>inPropertyID: <strong>AudioFileStreamPropertyID</strong> \u5c5e\u6027\u4fe1\u606f\u7c7b\u578b.</li>\n<li>ioFlags: \u8fd4\u56de\u53c2\u6570, \u8868\u793a\u8fd9\u4e2aproperty\u662f\u5426\u9700\u8981\u88ab\u7f13\u5b58, \u9700\u8981\u7f13\u5b58\u5219\u8d4b\u503c kAudioFileStreamPropertyFlag_PropertyIsCached, \u4e00\u822c\u4e0d\u7528\u8d4b\u503c\u5904\u7406.</li>\n</ul>\n<p><strong>AudioFileStream_PropertyListenerProc</strong> \u4f1a\u591a\u6b21\u89e6\u53d1, \u53ef\u4ee5\u6839\u636e\u56de\u8c03\u7684 <strong>AudioFileStreamPropertyID</strong> \u53bb\u8bfb\u53d6\u5bf9\u5e94\u4fe1\u606f.</p>\n<h3 id=\"audiofilestreampropertyid\">AudioFileStreamPropertyID</h3>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">CF_ENUM</span><span class=\"p\">(</span><span class=\"n\">AudioFileStreamPropertyID</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_ReadyToProducePackets</span><span class=\"w\">          </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">redy</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_FileFormat</span><span class=\"w\">                     </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">ffmt</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_DataFormat</span><span class=\"w\">                     </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">dfmt</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_FormatList</span><span class=\"w\">                     </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">flst</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_MagicCookieData</span><span class=\"w\">                </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">mgic</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_AudioDataByteCount</span><span class=\"w\">             </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">bcnt</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_AudioDataPacketCount</span><span class=\"w\">           </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">pcnt</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_MaximumPacketSize</span><span class=\"w\">              </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">psze</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_DataOffset</span><span class=\"w\">                     </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">doff</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_ChannelLayout</span><span class=\"w\">                  </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">cmap</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_PacketToFrame</span><span class=\"w\">                  </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">pkfr</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_FrameToPacket</span><span class=\"w\">                  </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">frpk</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_RestrictsRandomAccess</span><span class=\"w\">          </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">rrap</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_PacketToRollDistance</span><span class=\"w\">           </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">pkrl</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_PreviousIndependentPacket</span><span class=\"w\">      </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">pind</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_NextIndependentPacket</span><span class=\"w\">          </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">nind</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_PacketToDependencyInfo</span><span class=\"w\">         </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">pkdp</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_PacketToByte</span><span class=\"w\">                   </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">pkby</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_ByteToPacket</span><span class=\"w\">                   </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">bypk</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_PacketTableInfo</span><span class=\"w\">                </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">pnfo</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_PacketSizeUpperBound</span><span class=\"w\">           </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">pkub</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_AverageBytesPerPacket</span><span class=\"w\">          </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">abpp</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_BitRate</span><span class=\"w\">                        </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">brat</span><span class=\"err\">&#39;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">kAudioFileStreamProperty_InfoDictionary</span><span class=\"w\">                 </span><span class=\"o\">=</span><span class=\"w\">   </span><span class=\"err\">&#39;</span><span class=\"n\">info</span><span class=\"err\">&#39;</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n\n<h4 id=\"kaudiofilestreamproperty_readytoproducepackets\">kAudioFileStreamProperty_ReadyToProducePackets</h4>\n<p>\u8868\u793a\u97f3\u9891\u4fe1\u606f\u89e3\u6790\u5b8c\u6210, \u5f00\u59cb\u5206\u79bb\u97f3\u9891\u5e27. </p>\n<h4 id=\"kaudiofilestreamproperty_dataoffset\">kAudioFileStreamProperty_DataOffset</h4>\n<p>\u83b7\u53d6\u97f3\u9891\u5185\u5bb9\u5728\u97f3\u9891\u6d41\u4e2d\u5f00\u59cb\u7684\u4f4d\u7f6e</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">SInt64</span><span class=\"w\"> </span><span class=\"n\">dataOffset</span>\n<span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">offsetSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">dataOffset</span><span class=\"p\">);</span>\n<span class=\"n\">AudioFileStreamGetProperty</span><span class=\"p\">(</span><span class=\"n\">_audioFileStreamID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioFileStreamProperty_DataOffset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">offsetSize</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">dataOffset</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h4 id=\"kaudiofilestreamproperty_audiodatabytecount\">kAudioFileStreamProperty_AudioDataByteCount</h4>\n<p>\u83b7\u53d6\u97f3\u9891\u6d41\u4e2d\u97f3\u9891\u5185\u5bb9\u6570\u636e\u957f\u5ea6</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">SInt64</span><span class=\"w\"> </span><span class=\"n\">audioDataByteCount</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">sizeOfUInt32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">audioDataByteCount</span><span class=\"p\">);</span>\n<span class=\"n\">AudioFileStreamGetProperty</span><span class=\"p\">(</span><span class=\"n\">_audioFileStreamID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioFileStreamProperty_AudioDataByteCount</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">sizeOfUInt32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">audioDataByteCount</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<p>\u5982\u83b7\u53d6\u4e0d\u5230, \u53ef\u4ee5\u901a\u8fc7 fileSize(\u97f3\u9891\u6587\u4ef6\u603b\u957f\u5ea6) \u548c <strong>kAudioFileStreamProperty_DataOffset</strong> \u8ba1\u7b97\u83b7\u5f97.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">SInt64</span><span class=\"w\"> </span><span class=\"n\">audioDataByteCount</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fileSize</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">dataOffset</span><span class=\"p\">;</span>\n</code></pre></div>\n\n<h4 id=\"kaudiofilestreamproperty_bitrate\">kAudioFileStreamProperty_BitRate</h4>\n<p>\u83b7\u53d6\u97f3\u9891\u6570\u636e\u7684\u7801\u7387, \u83b7\u53d6\u8fd9\u4e2amalProperty \u662f\u4e3a\u4e86\u8ba1\u7b97\u97f3\u9891\u7684\u603b\u65f6\u957f Duration. </p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"c1\">/// \u8fd9\u662f CBR \u56fa\u5b9a\u7801\u7387\u97f3\u9891\u7684\u8ba1\u7b97\u65b9\u5f0f, VBR \u9700\u89e3\u6790 Xing \u5934\u83b7\u53d6\u603b\u5e27\u6570, \u603b\u5e27\u6570 * \u5e27\u65f6\u957f.</span>\n<span class=\"n\">estimatedDuration</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">audioDataByteCount</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mf\">8.0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">bitRate</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1000</span>\n</code></pre></div>\n\n<p>BitRate \u53ef\u80fd\u83b7\u53d6\u4e0d\u5230\u6216\u8005\u4e3a 0, \u90a3\u4e48\u5c31\u9700\u8981\u6839\u636e\u89e3\u6790\u7684\u97f3\u9891\u5e27\u8fdb\u884c\u8ba1\u7b97\u5e73\u5747\u7801\u7387.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">averagePacketSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">packetsSizeTotal</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">packetsCount</span><span class=\"p\">;</span>\n<span class=\"n\">packetDuration</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fileFormat</span><span class=\"p\">.</span><span class=\"n\">mFramesPerPacket</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">fileFormat</span><span class=\"p\">.</span><span class=\"n\">mSampleRate</span><span class=\"p\">;</span>\n<span class=\"n\">averageBitRate</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\">  </span><span class=\"mf\">8.0</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">averagePacketSize</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">packetDuration</span><span class=\"p\">;</span>\n</code></pre></div>\n\n<h4 id=\"kaudiofilestreamproperty_dataformat\">kAudioFileStreamProperty_DataFormat</h4>\n<p>\u57fa\u7840\u6587\u4ef6\u683c\u5f0f, \u8fd9\u4e2a\u5c5e\u6027\u7528\u4e8e\u83b7\u53d6\u97f3\u9891\u6d41\u7684\u6570\u636e\u683c\u5f0f. \u901a\u8fc7\u67e5\u8be2\u8fd9\u4e2a\u5c5e\u6027, \u4f60\u53ef\u4ee5\u83b7\u5f97\u6709\u5173\u97f3\u9891\u6d41\u7684\u57fa\u672c\u4fe1\u606f, \u5982\u91c7\u6837\u7387\u3001\u58f0\u9053\u6570\u3001\u7f16\u7801\u683c\u5f0f\u7b49.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"bp\">AudioStreamBasicDescription</span><span class=\"w\"> </span><span class=\"n\">baseFormat</span><span class=\"p\">;</span>\n<span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">asbdSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">baseFormat</span><span class=\"p\">);</span>\n<span class=\"n\">AudioFileStreamGetProperty</span><span class=\"p\">(</span><span class=\"n\">_audioFileStreamID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioFileStreamProperty_DataFormat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">asbdSize</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">baseFormat</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h4 id=\"kaudiofilestreamproperty_formatlist\">kAudioFileStreamProperty_FormatList</h4>\n<p>\u8fd9\u4e2a\u5c5e\u6027\u7528\u4e8e\u83b7\u53d6\u97f3\u9891\u6d41\u652f\u6301\u7684\u6240\u6709\u683c\u5f0f\u5217\u8868. \u5f53\u4e00\u4e2a\u97f3\u9891\u6d41\u652f\u6301\u591a\u79cd\u683c\u5f0f\u65f6, \u4f60\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u5c5e\u6027\u6765\u83b7\u53d6\u6240\u6709\u652f\u6301\u7684\u683c\u5f0f\u5217\u8868. </p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kt\">Boolean</span><span class=\"w\"> </span><span class=\"n\">outWriteable</span><span class=\"p\">;</span>\n<span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">formatListSize</span><span class=\"p\">;</span>\n<span class=\"n\">OSStatus</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AudioFileStreamGetPropertyInfo</span><span class=\"p\">(</span><span class=\"n\">_audioFileStreamID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioFileStreamProperty_FormatList</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">formatListSize</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">outWriteable</span><span class=\"p\">);</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">noErr</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"bp\">AudioFormatListItem</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">formatList</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"n\">formatListSize</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">OSStatus</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AudioFileStreamGetProperty</span><span class=\"p\">(</span><span class=\"n\">_audioFileStreamID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioFileStreamProperty_FormatList</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">formatListSize</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">formatList</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">noErr</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">supportedFormatsSize</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AudioFormatGetPropertyInfo</span><span class=\"p\">(</span><span class=\"n\">kAudioFormatProperty_DecodeFormatIDs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">supportedFormatsSize</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">noErr</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">formatList</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n\n<span class=\"w\">        </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">supportedFormatCount</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">supportedFormatsSize</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">OSType</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">OSType</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">supportedFormats</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">OSType</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"n\">supportedFormatsSize</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AudioFormatGetProperty</span><span class=\"p\">(</span><span class=\"n\">kAudioFormatProperty_DecodeFormatIDs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">supportedFormatsSize</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">supportedFormats</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">noErr</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">formatList</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">supportedFormats</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n\n<span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">sizeof</span><span class=\"p\">(</span><span class=\"bp\">AudioFormatListItem</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">formatListSize</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"bp\">AudioFormatListItem</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"bp\">AudioStreamBasicDescription</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">formatList</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">mASBD</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">supportedFormatCount</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"n\">j</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">format</span><span class=\"p\">.</span><span class=\"n\">mFormatID</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">supportedFormats</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"p\">])</span>\n<span class=\"w\">                </span><span class=\"p\">{</span>\n<span class=\"w\">                    </span><span class=\"c1\">/// \u652f\u6301\u7684 format</span>\n<span class=\"w\">                    </span><span class=\"k\">break</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">supportedFormats</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">formatList</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n<h4 id=\"kaudiofilestreamproperty_audiodatapacketcount\">kAudioFileStreamProperty_AudioDataPacketCount</h4>\n<p>\u83b7\u53d6\u97f3\u9891\u5e27(packet)\u603b\u6570, \u6b64\u4fe1\u606f\u5b58\u5728\u8bef\u5dee\u6216\u4e0d\u51c6\u786e.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">SInt64</span><span class=\"w\"> </span><span class=\"n\">packetCountSize</span><span class=\"p\">;</span>\n<span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">sizeOfUInt32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">packetCountSize</span><span class=\"p\">);</span>\n<span class=\"n\">AudioFileStreamGetProperty</span><span class=\"p\">(</span><span class=\"n\">_audioFileStreamID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioFileStreamProperty_AudioDataPacketCount</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">sizeOfUInt32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">packetCountSize</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h4 id=\"kaudiofilestreamproperty_averagebytesperpacket\">kAudioFileStreamProperty_AverageBytesPerPacket</h4>\n<p>\u7528\u4e8e\u83b7\u53d6\u97f3\u9891\u6d41\u4e2d\u6bcf\u4e2a\u6570\u636e\u5305\uff08packet\uff09\u7684\u5e73\u5747\u5b57\u8282\u6570. \u5728\u5904\u7406\u97f3\u9891\u6587\u4ef6\u6216\u6d41\u65f6, \u8fd9\u4e2a\u5c5e\u6027\u53ef\u4ee5\u63d0\u4f9b\u6709\u5173\u97f3\u9891\u6570\u636e\u5305\u5927\u5c0f\u7684\u4fe1\u606f, \u6709\u52a9\u4e8e\u89e3\u6790\u548c\u5904\u7406\u97f3\u9891\u6570\u636e\u6d41.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">SInt64</span><span class=\"w\"> </span><span class=\"n\">packetCountSize</span><span class=\"p\">;</span>\n<span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">sizeOfUInt32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">packetCountSize</span><span class=\"p\">);</span>\n<span class=\"n\">AudioFileStreamGetProperty</span><span class=\"p\">(</span><span class=\"n\">_audioFileStreamID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioFileStreamProperty_AverageBytesPerPacket</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">sizeOfUInt32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">packetCountSize</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h4 id=\"kaudiofilestreamproperty_maximumpacketsize\">kAudioFileStreamProperty_MaximumPacketSize</h4>\n<p>\u83b7\u53d6\u6700\u5927\u97f3\u9891\u5e27\u6700\u5927\u503c, \u6bd4\u8f83\u8d34\u8fd1\u5b9e\u9645\u5927\u5c0f.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">realityMaxPacketSize</span><span class=\"p\">;</span>\n<span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">sizeOfUInt32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">realityMaxPacketSize</span><span class=\"p\">);</span>\n<span class=\"n\">AudioFileStreamGetProperty</span><span class=\"p\">(</span><span class=\"n\">_audioFileStreamID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioFileStreamProperty_MaximumPacketSize</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">sizeOfUInt32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">realityMaxPacketSize</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h4 id=\"kaudiofilestreamproperty_packetsizeupperbound\">kAudioFileStreamProperty_PacketSizeUpperBound</h4>\n<p>\u83b7\u53d6\u97f3\u9891\u5e27\u6700\u5927\u8fb9\u754c\u5927\u5c0f, \u7406\u8bba\u6700\u5927.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">maxPacketSize</span><span class=\"p\">;</span>\n<span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">sizeOfUInt32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">maxPacketSize</span><span class=\"p\">);</span>\n<span class=\"n\">AudioFileStreamGetProperty</span><span class=\"p\">(</span><span class=\"n\">_audioFileStreamID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioFileStreamProperty_PacketSizeUpperBound</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">sizeOfUInt32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">maxPacketSize</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h2 id=\"_4\">\u5206\u79bb\u97f3\u9891\u5e27</h2>\n<p>\u5728\u63a5\u6536\u5230 <strong>kAudioFileStreamProperty_ReadyToProducePackets</strong> \u540e, <strong>AudioFileStreamParseBytes</strong> \u5f00\u59cb\u5206\u79bb\u97f3\u9891\u5e27, \u5206\u79bb\u5b8c\u6210\u4f1a\u89e6\u53d1 <strong>AudioFileStream_PacketsProc</strong> \u56de\u8c03.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">AudioFileStream_PacketsProc</span><span class=\"p\">)(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">inClientData</span><span class=\"p\">,</span>\n<span class=\"w\">                                            </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">numberOfBytes</span><span class=\"p\">,</span>\n<span class=\"w\">                                            </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">numberOfPackets</span><span class=\"p\">,</span>\n<span class=\"w\">                                            </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">inInputData</span><span class=\"p\">,</span>\n<span class=\"w\">                                            </span><span class=\"bp\">AudioStreamPacketDescription</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">inPacketDescriptions</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<ul>\n<li>inClientData: \u4e0a\u4e0b\u6587\u5bf9\u8c61.</li>\n<li>numberOfBytes: \u672c\u6b21\u89e3\u6790\u7684\u6570\u636e\u5927\u5c0f.</li>\n<li>numberOfPackets: \u672c\u6b21\u5206\u79bb\u7684\u97f3\u9891\u5e27\u6570.</li>\n<li>inInputData: \u672c\u6b21\u5904\u7406\u7684\u6240\u6709\u6570\u636e.</li>\n<li>inPacketDescriptions: \u97f3\u9891\u5e27\u4fe1\u606f, \u8bb0\u5f55\u97f3\u9891\u5e27\u5728\u672c\u6b21\u6570\u636e\u4e2d\u7684\u5b57\u8282\u8303\u56f4\u548c\u5b57\u8282\u5927\u5c0f.</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">struct</span><span class=\"w\">  </span><span class=\"bp\">AudioStreamPacketDescription</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">SInt64</span><span class=\"w\">  </span><span class=\"n\">mStartOffset</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">/// \u5f00\u59cb\u5b57\u8282\u4f4d\u7f6e</span>\n<span class=\"w\">    </span><span class=\"kt\">UInt32</span><span class=\"w\">  </span><span class=\"n\">mVariableFramesInPacket</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">/// \u591a\u5c11\u4e2a\u6570\u636e\u5e27</span>\n<span class=\"w\">    </span><span class=\"kt\">UInt32</span><span class=\"w\">  </span><span class=\"n\">mDataByteSize</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">/// \u97f3\u9891\u5e27\u5927\u5c0f</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n\n<p>\u5904\u7406\u5206\u79bb\u7684\u97f3\u9891\u5e27:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"c1\">/// packets: const void * inInputData</span>\n\n<span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"p\">)</span><span class=\"nf\">handleAudioFileStreamPackets:</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">packets</span>\n<span class=\"w\">                       </span><span class=\"nl\">numberOfBytes</span><span class=\"p\">:(</span><span class=\"kt\">UInt32</span><span class=\"p\">)</span><span class=\"nv\">numberOfBytes</span>\n<span class=\"w\">                     </span><span class=\"nl\">numberOfPackets</span><span class=\"p\">:(</span><span class=\"kt\">UInt32</span><span class=\"p\">)</span><span class=\"nv\">numberOfPackets</span>\n<span class=\"w\">                  </span><span class=\"nl\">packetDescriptions</span><span class=\"p\">:(</span><span class=\"bp\">AudioStreamPacketDescription</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">packetDescriptioins</span>\n<span class=\"p\">{</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">numberOfBytes</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">numberOfPackets</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"kt\">BOOL</span><span class=\"w\"> </span><span class=\"n\">deletePackDesc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NO</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">packetDescriptioins</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// \u5982\u679cpacketDescriptioins\u4e0d\u5b58\u5728, \u5c31\u6309\u7167CBR\u5904\u7406, \u5e73\u5747\u6bcf\u4e00\u5e27\u7684\u6570\u636e\u540e\u751f\u6210packetDescriptioins</span>\n<span class=\"w\">        </span><span class=\"n\">deletePackDesc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">YES</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">packetSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">numberOfBytes</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">numberOfPackets</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"bp\">AudioStreamPacketDescription</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">descriptions</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"bp\">AudioStreamPacketDescription</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">malloc</span><span class=\"p\">(</span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"bp\">AudioStreamPacketDescription</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">numberOfPackets</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">numberOfPackets</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">packetOffset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">packetSize</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"c1\">/// \u5f00\u59cb\u4f4d\u7f6e</span>\n<span class=\"w\">            </span><span class=\"n\">descriptions</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">mStartOffset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">packetOffset</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"c1\">/// \u6570\u636e\u5e27\u6570\u91cf</span>\n<span class=\"w\">            </span><span class=\"n\">descriptions</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">mVariableFramesInPacket</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"c1\">/// \u8ba1\u7b97\u6570\u636e\u5927\u5c0f</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">numberOfPackets</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"n\">descriptions</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">mDataByteSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">numberOfBytes</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">packetOffset</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"k\">else</span>\n<span class=\"w\">            </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"n\">descriptions</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">mDataByteSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">packetSize</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"n\">packetDescriptioins</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">descriptions</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">numberOfPackets</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"n\">i</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">SInt64</span><span class=\"w\"> </span><span class=\"n\">packetOffset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">packetDescriptioins</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">].</span><span class=\"n\">mStartOffset</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"n\">dataWithBytes</span><span class=\"o\">:</span><span class=\"n\">packets</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">packetOffset</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"o\">:</span><span class=\"n\">packetDescription</span><span class=\"p\">.</span><span class=\"n\">mDataByteSize</span><span class=\"p\">];</span>\n<span class=\"w\">        </span><span class=\"p\">...</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">deletePackDesc</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">packetDescriptioins</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n<h2 id=\"audiofilestreamseek\">AudioFileStreamSeek</h2>\n<p><strong>AudioFileStreamSeek</strong> \u53ef\u4ee5\u7528\u6765\u5bfb\u627e\u67d0\u4e00\u4e2a\u5e27\uff08Packet\uff09\u5bf9\u5e94\u7684\u5b57\u8282\u504f\u79fb\uff08byte offset\uff09</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"n\">OSStatus</span>\n<span class=\"nf\">AudioFileStreamSeek</span><span class=\"p\">(</span><span class=\"w\">    </span>\n<span class=\"w\">                </span><span class=\"n\">AudioFileStreamID</span><span class=\"w\"> </span><span class=\"n\">inAudioFileStream</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">SInt64</span><span class=\"w\">  </span><span class=\"n\">inPacketOffset</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">SInt64</span><span class=\"w\">  </span><span class=\"o\">*</span><span class=\"n\">outDataByteOffset</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"n\">AudioFileStreamSeekFlags</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ioFlags</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<ul>\n<li>inPacketOffset: \u97f3\u9891\u6587\u4ef6\u4e2d\u7b2c\u51e0\u4e2a\u97f3\u9891\u5e27.</li>\n<li>outDataByteOffset: \u8f93\u51fa\u97f3\u9891\u5e27\u5728\u6587\u4ef6\u4e2d\u7684\u5b57\u8282\u4f4d\u7f6e.</li>\n<li>ioFlags:  \u5982\u679c\u662f <strong>kAudioFileStreamSeekFlag_OffsetIsEstimated</strong> \u503c\u8868\u660e\u83b7\u53d6\u7684 outDataByteOffset \u503c\u662f\u9884\u4f30\u7684\u5e76\u4e0d\u51c6\u786e, \u53cd\u5219, \u83b7\u5f97\u662f\u51c6\u786e\u7684\u503c.</li>\n</ul>\n<h2 id=\"audiofilestream_1\">\u5173\u95edAudioFileStream</h2>\n<p>AudioFileStream \u4f7f\u7528\u5b8c\u6bd5\u540e\u9700\u8981\u8c03\u7528 <strong>AudioFileStreamClose</strong> \u8fdb\u884c\u5173\u95ed.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"n\">OSStatus</span><span class=\"w\"> </span><span class=\"nf\">AudioFileStreamClose</span><span class=\"p\">(</span><span class=\"n\">AudioFileStreamID</span><span class=\"w\"> </span><span class=\"n\">inAudioFileStream</span><span class=\"p\">);</span><span class=\"w\"> </span>\n</code></pre></div>"}