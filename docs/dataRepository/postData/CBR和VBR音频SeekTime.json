{"title": "CBR\u3001VBR\u97f3\u9891 SeekTime", "date": "2024-03-12 19:50:30", "categories": "\u97f3\u89c6\u9891", "tags": "Audio", "keywords": "CBR,VBR,SeekTime", "description": "", "images": "", "file_name": "CBR\u548cVBR\u97f3\u9891SeekTime", "short": " \u97f3\u9891 Seek Time \u529f\u80fd\u9700\u8981\u6211\u4eec\u5728\u97f3\u9891\u6587\u4ef6\u4e2d\u627e\u5230\u5bf9\u5e94\u64ad\u653e\u65f6\u95f4\u70b9\u7684\u5b57\u8282\u4f4d\u7f6e, \u8fd9\u6837\u624d\u80fd\u5b9e\u73b0\u64ad\u653e\u65f6\u95f4\u70b9\u7684\u8df3\u8dc3.  \n \u97f3\u9891\u5b58\u5728 CBR\u3001VBR\u3001CVBR \u7b49\u7801\u7387\u7f16\u7801\u65b9\u5f0f, \u5f71\u54cd\u6bcf\u4e00\u5e27\u7684\u6570\u636e\u957f\u5ea6\u5927\u5c0f. \u8fd9\u610f\u5473\u7740\u5bf9\u4e8e\u4e0d\u540c\u7801\u7387\u7f16\u7801\u7684\u97f3\u9891, \u5b9e\u73b0 Seek Time \u7684\u65b9\u5f0f\u4e5f\u4e0d\u4e00\u6837, \u8fd9\u91cc\u4e3b\u8981\u9488\u5bf9 CBR \u548c VBR. \n ", "content": "<p>\u97f3\u9891 Seek Time \u529f\u80fd\u9700\u8981\u6211\u4eec\u5728\u97f3\u9891\u6587\u4ef6\u4e2d\u627e\u5230\u5bf9\u5e94\u64ad\u653e\u65f6\u95f4\u70b9\u7684\u5b57\u8282\u4f4d\u7f6e, \u8fd9\u6837\u624d\u80fd\u5b9e\u73b0\u64ad\u653e\u65f6\u95f4\u70b9\u7684\u8df3\u8dc3. </p>\n<p>\u97f3\u9891\u5b58\u5728 CBR\u3001VBR\u3001CVBR \u7b49\u7801\u7387\u7f16\u7801\u65b9\u5f0f, \u5f71\u54cd\u6bcf\u4e00\u5e27\u7684\u6570\u636e\u957f\u5ea6\u5927\u5c0f. \u8fd9\u610f\u5473\u7740\u5bf9\u4e8e\u4e0d\u540c\u7801\u7387\u7f16\u7801\u7684\u97f3\u9891, \u5b9e\u73b0 Seek Time \u7684\u65b9\u5f0f\u4e5f\u4e0d\u4e00\u6837, \u8fd9\u91cc\u4e3b\u8981\u9488\u5bf9 CBR \u548c VBR.</p>\n<!-- more -->\n<h3 id=\"cbr\">CBR</h3>\n<p>CBR\u4ee3\u8868\u6052\u5b9a\u6bd4\u7279\u7387\uff08Constant Bit Rate\uff09, \u5176\u4e2d\u97f3\u9891\u6570\u636e\u4ee5\u6052\u5b9a\u7684\u6bd4\u7279\u7387\u8fdb\u884c\u4f20\u8f93\u6216\u5b58\u50a8. \u5728CBR\u7f16\u7801\u4e2d, \u6bcf\u79d2\u4f20\u8f93\u7684\u6bd4\u7279\u6570\u4fdd\u6301\u4e0d\u53d8, \u8fd9\u610f\u5473\u7740\u65e0\u8bba\u97f3\u9891\u5185\u5bb9\u590d\u6742\u5ea6\u5982\u4f55, \u6587\u4ef6\u5927\u5c0f\u4e5f\u4f1a\u4fdd\u6301\u4e00\u81f4. CBR \u7684\u97f3\u9891\u6bcf\u4e00\u5e27\u7684\u5927\u5c0f\u548c\u65f6\u957f\u90fd\u4fdd\u6301\u4e00\u81f4, \u5bf9\u4e8e CBR \u7684 Seek Time \u5b9e\u73b0\u4e5f\u5c31\u6bd4\u8f83\u5bb9\u6613.</p>\n<p>\u7531\u4e8e CBR \u97f3\u9891\u6bcf\u5e27\u5927\u5c0f\u4e00\u81f4, \u6211\u4eec\u53ef\u4ee5\u8fd1\u4f3c\u7684\u7b97\u51fa\u65f6\u95f4\u70b9\u5bf9\u5e94\u7684\u5b57\u8282\u4f4d\u7f6e:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"c1\">/// dataOffset  kAudioFileStreamProperty_DataOffset</span>\n<span class=\"c1\">/// audioDataByteCount  kAudioFileStreamProperty_AudioDataByteCount</span>\n<span class=\"n\">NSTimeInterval</span><span class=\"w\"> </span><span class=\"n\">estimatedDuration</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">audioDataByteCount</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mf\">8.0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">bitRate</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1000</span>\n<span class=\"n\">NSUInteger</span><span class=\"w\"> </span><span class=\"n\">approximateSeekOffset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">dataOffset</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">seekTime</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">estimatedDuration</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mf\">1000.0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">audioDataByteCount</span><span class=\"p\">;</span>\n</code></pre></div>\n\n<p>\u901a\u8fc7 seekTime / packetDuration \u53ef\u4ee5\u83b7\u53d6\u662f\u7b2c\u51e0\u4e2a\u97f3\u9891\u5e27, \u7136\u540e\u901a\u8fc7 <strong>AudioFileStreamSeek</strong> \u65b9\u6cd5\u53ef\u4ee5\u83b7\u53d6\u97f3\u9891\u5e27\u6240\u5728\u7684\u5b57\u8282\u4f4d\u7f6e.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">NSTimeInterval</span><span class=\"w\"> </span><span class=\"n\">packetDuration</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fileFormat</span><span class=\"p\">.</span><span class=\"n\">mFramesPerPacket</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">fileFormat</span><span class=\"p\">.</span><span class=\"n\">mSampleRate</span><span class=\"p\">;</span>\n<span class=\"n\">SInt64</span><span class=\"w\"> </span><span class=\"n\">seekToPacket</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">floor</span><span class=\"p\">(</span><span class=\"n\">seekTime</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">packetDuration</span><span class=\"p\">);</span>\n<span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">ioFlags</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"n\">SInt64</span><span class=\"w\"> </span><span class=\"n\">outDataByteOffset</span><span class=\"p\">;</span>\n<span class=\"n\">OSStatus</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AudioFileStreamSeek</span><span class=\"p\">(</span><span class=\"n\">_audioFileStreamID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">seekToPacket</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">outDataByteOffset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">ioFlags</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<p>\u5982\u679c ioFlags \u5305\u542b <strong>kAudioFileStreamSeekFlag_OffsetIsEstimated</strong>, \u8bf4\u660e\u83b7\u5f97\u7684\u5b57\u8282\u4f4d\u7f6e\u662f\u4e0d\u51c6\u786e\u7684, \u56e0\u6b64\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 <strong>approximateSeekOffset</strong>, \u53cd\u4e4b, \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <strong>AudioFileStreamSeek</strong> \u83b7\u5f97\u7684 <strong>outDataByteOffset</strong>, \u540c\u65f6, \u6211\u4eec\u9700\u8981\u4fee\u6b63\u4e00\u4e0b SeekTime.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">noErr</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">ioFlags</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">kAudioFileStreamSeekFlag_OffsetIsEstimated</span><span class=\"p\">))</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u5982\u679cAudioFileStreamSeek\u65b9\u6cd5\u627e\u5230\u4e86\u51c6\u786e\u7684\u5e27\u5b57\u8282\u504f\u79fb, \u9700\u8981\u4fee\u6b63\u4e00\u4e0b\u65f6\u95f4</span>\n<span class=\"w\">    </span><span class=\"n\">seekTime</span><span class=\"w\"> </span><span class=\"o\">-=</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">approximateSeekOffset</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">dataOffset</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">outDataByteOffset</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mf\">8.0</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">bitRate</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">outDataByteOffset</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dataOffset</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"k\">else</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">approximateSeekOffset</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n<h3 id=\"vbr\">VBR</h3>\n<p>VBR\u4ee3\u8868\u53ef\u53d8\u6bd4\u7279\u7387\uff08Variable Bit Rate\uff09, \u5176\u4e2d\u97f3\u9891\u6570\u636e\u4ee5\u6839\u636e\u5185\u5bb9\u590d\u6742\u5ea6\u800c\u53d8\u5316\u7684\u6bd4\u7279\u7387\u8fdb\u884c\u4f20\u8f93\u6216\u5b58\u50a8. \u5728VBR\u7f16\u7801\u4e2d, \u7f16\u7801\u5668\u4f1a\u52a8\u6001\u8c03\u6574\u6bd4\u7279\u7387, \u4ee5\u4fbf\u66f4\u6709\u6548\u5730\u8868\u793a\u97f3\u9891\u5185\u5bb9, \u4ece\u800c\u5728\u4fdd\u6301\u9ad8\u8d28\u91cf\u7684\u540c\u65f6\u51cf\u5c11\u6587\u4ef6\u5927\u5c0f. VBR \u6bcf\u4e00\u5e27\u7684\u65f6\u957f\u662f\u4e00\u6837\u7684, \u4f46\u662f\u6570\u636e\u5927\u5c0f\u662f\u4e0d\u4e00\u81f4\u7684, \u56e0\u6b64\u65e0\u6cd5\u91c7\u7528 CBR \u65b9\u5f0f\u53bb\u8ba1\u7b97\u65f6\u95f4\u70b9\u5bf9\u5e94\u7684\u5b57\u8282\u4f4d\u7f6e, \u4ee5\u53ca\u8ba1\u7b97\u97f3\u9891\u6587\u4ef6\u603b\u65f6\u957f.</p>\n<p>\u4e3a\u4e86\u89e3\u51b3\u4e0a\u8ff0\u7684\u4e24\u4e2a\u95ee\u9898, VBR \u7f16\u7801\u589e\u52a0\u4e86\u4e00\u4e9b\u6570\u636e\u5b57\u6bb5. \u76ee\u524d VBR \u7f16\u7801\u6280\u672f\u4e3b\u8981\u6709\u4e24\u79cd, \u4e00\u79cd\u662f Xing \u516c\u53f8\u63d0\u51fa\u7684 Xing \u89c4\u8303, \u4e00\u79cd\u662f Fraunhofer \u7f16\u7801\u5668\u7684 VBRI \u89c4\u8303, \u7531\u4e8e\u4f7f\u7528 VBRI \u89c4\u8303\u7684 VBR \u7f16\u7801\u4e0d\u5e38\u89c1, \u5927\u591a\u6570 VBR \u7f16\u7801\u90fd\u662f\u91c7\u7528 Xing \u89c4\u8303, \u56e0\u6b64\u53ea\u9488\u5bf9 Xing \u89c4\u8303\u5b9e\u73b0. </p>\n<p>Xing \u89c4\u8303\u7684\u4e3b\u8981\u5185\u5bb9\u662f Xing \u5934, \u8fd9\u662f\u6307 VBR \u7f16\u7801\u7684\u97f3\u9891\u7684\u5f00\u5934\u7b2c\u4e00\u4e2a\u97f3\u9891\u5e27\u4e0d\u7528\u6765\u5b58\u50a8\u5177\u4f53\u7684\u97f3\u9891\u6570\u636e, \u800c\u662f\u7528\u6765\u5b58\u50a8\u4e00\u4e9b\u989d\u5916\u7684\u97f3\u9891\u4fe1\u606f. \u8fd9\u4e9b\u4fe1\u606f\u4ee5 \u201cXing\u201d \u8fd9\u56db\u4e2a\u5b57\u7b26\u4f5c\u4e3a\u5b57\u6bb5\u5f00\u5934\u7684\u6807\u8bb0\uff08\u4e5f\u6709\u90e8\u5206\u6587\u4ef6\u4ee5 \u201cInfo\u201d \u8fd9\u56db\u4e2a\u5b57\u7b26\u4f5c\u4e3a Xing \u5934\u7684\u5f00\u5934\u6807\u8bb0\uff09.</p>\n<p>Xing\u5934\u5728\u7b2c\u4e00\u4e2a\u97f3\u9891\u5e27\u4e2d\u7684\u4f4d\u7f6e, \u662f\u5728\u6807\u51c6\u76844\u4e2abyte\u7684\u97f3\u9891\u5e27\u5e27\u5934\u4e4b\u540e, \u5728\u5e27\u5934\u548c Xing \u5934\u4e4b\u95f4, \u4f1a\u6709\u4e00\u6bb5\u6570\u636e\u5185\u5bb9\u5168\u662f0\u7684\u7a7a\u767d\u90e8\u5206, \u8fd9\u4e2a\u7a7a\u767d\u90e8\u5206\u7684\u957f\u5ea6\u662f\u6307\u5b9a\u7684. \u89e3\u7801\u5668\u5728\u89e3\u6790\u5230\u7b2c\u4e00\u4e2a\u97f3\u9891\u5e27\u7684\u5e27\u5934\u4e4b\u540e, \u5c31\u662f\u901a\u8fc7\u8df3\u8fc7\u8fd9\u6bb5\u6307\u5b9a\u957f\u5ea6\u7684\u7a7a\u767d\u90e8\u5206, \u7136\u540e\u5224\u65ad\u63a5\u4e0b\u6765\u7684\u5185\u5bb9\u662f\u5426\u5c31\u662f \u2018Xing\u2019 \u6216\u8005 \u2018Info\u2019 \u8fd9\u56db\u4e2a\u5b57\u7b26, \u6765\u5224\u65ad\u97f3\u9891\u662f\u5426VBR\u7f16\u7801. </p>\n<h4 id=\"xing\">Xing\u7ed3\u6784</h4>\n<p>Xing \u5934\u7684\u7ed3\u6784\u4fe1\u606f\u5982\u4e0b:</p>\n<table>\n<thead>\n<tr>\n<th>Xing\u5f00\u59cb\u5b57\u8282</th>\n<th>\u5b57\u8282\u957f\u5ea6</th>\n<th>\u542b\u4e49</th>\n<th>\u793a\u4f8b</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>4</td>\n<td>VBR\u5934\u6807\u8bb0, 4\u4e2aASCII\u5b57\u7b26\u7684VBR\u5934 ID, \u8981\u4e48\u662fXing, \u8981\u4e48\u662fInfo, \u65e0NULL\u7ed3\u5c3e\uff08\u666e\u901a\u5b57\u7b26\u4e32\u90fd\u4ee5NULL,\u5373\\0\u7ed3\u5c3e\uff09</td>\n<td>'Xing'</td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td>\u5b58\u653e\u4e00\u4e2a\u6807\u5fd7, \u7528\u4e8e\u8868\u793a\u63a5\u4e0b\u6765\u5b58\u5728\u54ea\u4e9b\u57df/\u5b57\u6bb5,\u5404\u5b57\u6bb5\u903b\u8f91\u6216\u7684\u7ed3\u679c\uff1a<br>0x0001 - \u603b\u5e27\u6570\u5b58\u50a8\u533a\u57df\u8bbe\u7f6e\u4e3a\u5b58\u5728, \u4e0d\u5305\u62ec\u7b2c\u4e00\u5e27.<br>0x0002 - \u6587\u4ef6\u957f\u5ea6\u5b58\u50a8\u533a\u57df\u8bbe\u7f6e\u4e3a\u5b58\u5728, \u4e0d\u5305\u62ec\u6807\u7b7e\uff1b<br>0x0004 - TOC \u7d22\u5f15\u5b58\u50a8\u533a\u57df\u8bbe\u7f6e\u4e3a\u5b58\u5728\uff1b<br>0x0008 - \u8d28\u91cf\u6307\u793a\u5b58\u50a8\u533a\u57df\u8bbe\u7f6e\u4e3a\u5b58\u5728</td>\n<td>0x0007 \u5c31\u8868\u793a\u4e0b\u9762\u5b58\u5728\uff1a<br>0x0001 - \u603b\u5e27\u6570<br>0x0002 - \u6587\u4ef6\u957f\u5ea6<br>0x0004 - TOC \u7d22\u5f15</td>\n</tr>\n<tr>\n<td>8</td>\n<td>4</td>\n<td>\u603b\u5e27\u6570 Frames</td>\n<td>1912</td>\n</tr>\n<tr>\n<td>8 or 12</td>\n<td>4</td>\n<td>\u6587\u4ef6\u957f\u5ea6</td>\n<td>123456</td>\n</tr>\n<tr>\n<td>8 or 12 or 16</td>\n<td>100</td>\n<td>TOC \u8868</td>\n<td></td>\n</tr>\n<tr>\n<td>8 or 12 or 16 or 108 or 112 or 116</td>\n<td>4</td>\n<td>\u97f3\u9891\u8d28\u91cf\u6307\u793a, \u6700\u5dee0, \u6700\u597d100</td>\n<td>0</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"xing_1\">\u89e3\u6790 Xing</h4>\n<p>\u9996\u5148, \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <strong>kAudioFileStreamProperty_DataOffset</strong> \u62ff\u5230\u97f3\u9891\u6587\u4ef6\u4e2d\u5185\u5bb9\u8d77\u59cb\u4f4d\u7f6e, Xing \u5185\u5bb9\u4f1a\u5728 DataOffset \u4f4d\u7f6e\u524d\u7b2c\u4e00\u5e27\u4e2d, DataOffset \u540e\u7d27\u63a5\u7740\u5c31\u662f\u4e0b\u4e00\u5e27, \u6240\u4ee5\u901a\u8fc7 DataOffset + 2 \u53ef\u4ee5\u83b7\u5f97\u97f3\u9891\u5e27\u5934\u6807\u8bc6.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">packetHeadTagLength</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span>\n<span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">fileData</span><span class=\"w\"> </span><span class=\"n\">subdataWithRange</span><span class=\"o\">:</span><span class=\"n\">NSMakeRange</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dataOffset</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">packetHeadTagLength</span><span class=\"p\">)];</span>\n<span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">firstData</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"n\">subdataWithRange</span><span class=\"o\">:</span><span class=\"n\">NSMakeRange</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dataOffset</span><span class=\"p\">)]</span>\n<span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">packetHeadTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"n\">subdataWithRange</span><span class=\"o\">:</span><span class=\"n\">NSMakeRange</span><span class=\"p\">(</span><span class=\"n\">dataOffset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">packetHeadTagLength</span><span class=\"p\">)]</span>\n</code></pre></div>\n\n<p>\u7136\u540e, \u901a\u8fc7\u97f3\u9891\u5e27\u5934\u6807\u8bc6, \u4ece DataOffset \u4f4d\u7f6e\u5f80\u524d\u5339\u914d\u5e27\u5934\u6807\u8bc6, \u627e\u5230\u7b2c\u4e00\u5e27\u5b8c\u6574\u6570\u636e.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">[</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">foundFirstPacket</span><span class=\"o\">:</span><span class=\"n\">firstData</span><span class=\"w\"> </span><span class=\"n\">packetHeadTag</span><span class=\"o\">:</span><span class=\"n\">packetHeadTag</span><span class=\"p\">];</span>\n\n\n<span class=\"p\">+</span> <span class=\"p\">(</span><span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nf\">foundFirstPacket:</span><span class=\"p\">(</span><span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">data</span><span class=\"w\"> </span><span class=\"nf\">packetHeadTag:</span><span class=\"p\">(</span><span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">packetHeadTag</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">packetHeadTag</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">nil</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"bp\">NSMutableArray</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">matchTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"bp\">NSMutableArray</span><span class=\"w\"> </span><span class=\"n\">array</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">packetHeadTagPtr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)[</span><span class=\"n\">packetHeadTag</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">packetHeadTag</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"n\">packetHeadTagPtr</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">[</span><span class=\"n\">matchTag</span><span class=\"w\"> </span><span class=\"n\">insertObject</span><span class=\"o\">:</span><span class=\"l\">@(</span><span class=\"n\">v</span><span class=\"l\">)</span><span class=\"w\"> </span><span class=\"n\">atIndex</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">packetData</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)[</span><span class=\"n\">packetData</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">matchIndex</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">matchPostion</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">packetData</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"o\">--</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">matchIndex</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">matchTag</span><span class=\"p\">.</span><span class=\"n\">count</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">matchTag</span><span class=\"p\">[</span><span class=\"n\">matchIndex</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">integerValue</span><span class=\"p\">])</span>\n<span class=\"w\">            </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"n\">matchIndex</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"n\">matchIndex</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">matchPostion</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"k\">break</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">matchPostion</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">nil</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">packetData</span><span class=\"w\"> </span><span class=\"n\">subdataWithRange</span><span class=\"o\">:</span><span class=\"n\">NSMakeRange</span><span class=\"p\">(</span><span class=\"n\">matchPostion</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">packetData</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">matchPostion</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)];</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n<p>\u627e\u5230\u7b2c\u4e00\u5e27\u540e, \u6211\u4eec\u53ef\u4ee5\u5f00\u59cb\u53bb\u5bfb\u627e Xing \u4fe1\u606f\u6570\u636e.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">firstPacketData</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">foundFirstPacket</span><span class=\"o\">:</span><span class=\"n\">firstData</span><span class=\"w\"> </span><span class=\"n\">packetHeadTag</span><span class=\"o\">:</span><span class=\"n\">packetHeadTag</span><span class=\"p\">];</span>\n<span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)[</span><span class=\"n\">firstPacketData</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">];</span>\n<span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">foundPosition</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span>\n<span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">firstPacketData</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">position</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">foundPosition</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">break</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">xingOrInfoData</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">firstPacketData</span><span class=\"w\"> </span><span class=\"n\">subdataWithRange</span><span class=\"o\">:</span><span class=\"n\">NSMakeRange</span><span class=\"p\">(</span><span class=\"n\">foundPosition</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">firstPacketData</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">foundPosition</span><span class=\"p\">)];</span>\n</code></pre></div>\n\n<p>\u627e\u5230 Xing \u4fe1\u606f\u6570\u636e, \u5c31\u53ef\u4ee5\u5f00\u59cb\u6309\u7ed3\u6784\u89e3\u6790.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tagData</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"n\">subdataWithRange</span><span class=\"o\">:</span><span class=\"n\">NSMakeRange</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)];</span>\n<span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">vbrTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[[</span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"n\">alloc</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">initWithData</span><span class=\"o\">:</span><span class=\"n\">tagData</span><span class=\"w\"> </span><span class=\"n\">encoding</span><span class=\"o\">:</span><span class=\"n\">NSUTF8StringEncoding</span><span class=\"p\">];</span>\n\n<span class=\"c1\">/// xing \u89e3\u6790</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">([</span><span class=\"n\">vbrTag</span><span class=\"p\">.</span><span class=\"n\">lowercaseString</span><span class=\"w\"> </span><span class=\"n\">isEqualToString</span><span class=\"o\">:</span><span class=\"s\">@&quot;xing&quot;</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">vbrTag</span><span class=\"p\">.</span><span class=\"n\">lowercaseString</span><span class=\"w\"> </span><span class=\"n\">isEqualToString</span><span class=\"o\">:</span><span class=\"s\">@&quot;info&quot;</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">xingTagData</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"n\">subdataWithRange</span><span class=\"o\">:</span><span class=\"n\">NSMakeRange</span><span class=\"p\">(</span><span class=\"n\">tagData</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">tagData</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"p\">)];</span>\n\n<span class=\"w\">    </span><span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">validTagData</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">xingTagData</span><span class=\"w\"> </span><span class=\"n\">subdataWithRange</span><span class=\"o\">:</span><span class=\"n\">NSMakeRange</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)];</span>\n<span class=\"w\">    </span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">validTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">intValue</span><span class=\"o\">:</span><span class=\"n\">validTagData</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"kt\">BOOL</span><span class=\"w\"> </span><span class=\"n\">hasTotalFrameCountTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NO</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">hasContentLengthTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NO</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">hasTocTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NO</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">hasQualityTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">NO</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">validTag</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">hasTotalFrameCountTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">YES</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">validTag</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">hasContentLengthTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">YES</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">validTag</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">hasTocTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">YES</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">validTag</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">hasQualityTag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">YES</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">readOffset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">hasTotalFrameCountTag</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">totalFrameCount</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">intValue</span><span class=\"o\">:</span><span class=\"p\">[</span><span class=\"n\">xingTagData</span><span class=\"w\"> </span><span class=\"n\">subdataWithRange</span><span class=\"o\">:</span><span class=\"n\">NSMakeRange</span><span class=\"p\">(</span><span class=\"n\">readOffset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)]];</span>\n<span class=\"w\">        </span><span class=\"n\">NSTimeInterval</span><span class=\"w\"> </span><span class=\"n\">estimatedDuration</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Float64</span><span class=\"p\">)</span><span class=\"n\">totalFrameCount</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">fileFormat</span><span class=\"p\">.</span><span class=\"n\">mFramesPerPacket</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">fileFormat</span><span class=\"p\">.</span><span class=\"n\">mSampleRate</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">readOffset</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">hasContentLengthTag</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">NSInteger</span><span class=\"w\"> </span><span class=\"n\">contentLength</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">intValue</span><span class=\"o\">:</span><span class=\"p\">[</span><span class=\"n\">xingTagData</span><span class=\"w\"> </span><span class=\"n\">subdataWithRange</span><span class=\"o\">:</span><span class=\"n\">NSMakeRange</span><span class=\"p\">(</span><span class=\"n\">readOffset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">)]];</span>\n<span class=\"w\">        </span><span class=\"n\">readOffset</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">hasTocTag</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// \u83b7\u53d6 TOC \u6570\u636e</span>\n<span class=\"w\">        </span><span class=\"bp\">NSData</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tocData</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">xingTagData</span><span class=\"w\"> </span><span class=\"n\">subdataWithRange</span><span class=\"o\">:</span><span class=\"n\">NSMakeRange</span><span class=\"p\">(</span><span class=\"n\">readOffset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">)];</span>\n<span class=\"w\">        </span><span class=\"c1\">// \u89e3\u6790 TOC \u6570\u636e</span>\n<span class=\"w\">        </span><span class=\"bp\">NSMutableArray</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tocArray</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"bp\">NSMutableArray</span><span class=\"w\"> </span><span class=\"n\">array</span><span class=\"p\">];</span>\n<span class=\"w\">        </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">tocBytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tocData</span><span class=\"p\">.</span><span class=\"n\">bytes</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">NSUInteger</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">tocData</span><span class=\"p\">.</span><span class=\"n\">length</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"n\">tocValue</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tocBytes</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">];</span>\n<span class=\"w\">            </span><span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">percentage</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">double</span><span class=\"p\">)</span><span class=\"n\">tocValue</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mf\">256.0</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"p\">[</span><span class=\"n\">tocArray</span><span class=\"w\"> </span><span class=\"n\">addObject</span><span class=\"o\">:</span><span class=\"l\">@(</span><span class=\"n\">percentage</span><span class=\"l\">)</span><span class=\"p\">];</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n<p>\u89e3\u6790\u5b8c\u540e, \u6211\u4eec\u4e3b\u8981\u83b7\u5f97\u97f3\u9891\u603b\u5e27\u6570 totalFrameCount \u548c TOC\u6570\u636e\u8868, \u7528\u4e8e\u8ba1\u7b97\u97f3\u9891\u603b\u65f6\u957f\u548c\u5b9e\u73b0 SeekTime \u529f\u80fd.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">NSTimeInterval</span><span class=\"w\"> </span><span class=\"n\">seekTime</span><span class=\"p\">;</span>\n<span class=\"n\">NSTimeInterval</span><span class=\"w\"> </span><span class=\"n\">estimatedDuration</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Float64</span><span class=\"p\">)</span><span class=\"n\">totalFrameCount</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">fileFormat</span><span class=\"p\">.</span><span class=\"n\">mFramesPerPacket</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">fileFormat</span><span class=\"p\">.</span><span class=\"n\">mSampleRate</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"p\">;</span>\n<span class=\"kt\">float</span><span class=\"w\"> </span><span class=\"n\">percent</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">estimatedDuration</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mf\">1000.0</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">;</span>\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"p\">)</span><span class=\"n\">percent</span><span class=\"p\">;</span>\n<span class=\"n\">position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">NSUInteger</span><span class=\"p\">)([</span><span class=\"n\">vbrToc</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">floatValue</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">fileSize</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">dataOffset</span><span class=\"p\">;</span>\n</code></pre></div>\n\n<p>\u5f97\u5230\u5b57\u8282\u4f4d\u7f6e position \u540e, \u5c31\u53ef\u4ee5\u8fdb\u884c Seek \u64cd\u4f5c\u4e86.</p>"}