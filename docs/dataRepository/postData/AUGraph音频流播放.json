{"title": "AUGraph \u97f3\u9891\u6d41\u64ad\u653e", "date": "2024-03-14 19:41:30", "categories": "\u97f3\u89c6\u9891", "tags": "Audio", "keywords": "AUGraph,AudioUnit,\u97f3\u9891\u6d41\u64ad\u653e", "description": "", "images": "", "file_name": "AUGraph\u97f3\u9891\u6d41\u64ad\u653e", "short": " AUGraph \u5c5e\u4e8e Core Audio \u6846\u67b6, \u7528\u4e8e\u63cf\u8ff0\u97f3\u9891\u5355\u5143\uff08Audio Unit\uff09\u4e4b\u95f4\u7684\u8fde\u63a5\u5173\u7cfb\u548c\u4fe1\u53f7\u6d41. AUGraph \u62bd\u8c61\u4e86\u97f3\u9891\u6d41\u7684\u5904\u7406\u8fc7\u7a0b, \u5b83\u4e0d\u76f4\u63a5\u63a7\u5236 Audio Unit, \u800c\u662f\u7531\u57fa\u7840\u5355\u5143\u8282\u70b9 AUNode \u7ba1\u7406. \u4e00\u4e2a AUNode \u5bf9\u5e94\u4e00\u4e2a Audio Unit. \n ", "content": "<p>AUGraph \u5c5e\u4e8e Core Audio \u6846\u67b6, \u7528\u4e8e\u63cf\u8ff0\u97f3\u9891\u5355\u5143\uff08Audio Unit\uff09\u4e4b\u95f4\u7684\u8fde\u63a5\u5173\u7cfb\u548c\u4fe1\u53f7\u6d41. AUGraph \u62bd\u8c61\u4e86\u97f3\u9891\u6d41\u7684\u5904\u7406\u8fc7\u7a0b, \u5b83\u4e0d\u76f4\u63a5\u63a7\u5236 Audio Unit, \u800c\u662f\u7531\u57fa\u7840\u5355\u5143\u8282\u70b9 AUNode \u7ba1\u7406. \u4e00\u4e2a AUNode \u5bf9\u5e94\u4e00\u4e2a Audio Unit.</p>\n<!-- more -->\n\n<h3 id=\"augraph\">AUGraph \u6784\u5efa</h3>\n<h4 id=\"1-augraph\">1.\u521b\u5efa AUGraph \u5b9e\u4f8b</h4>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">AUGraph</span><span class=\"w\"> </span><span class=\"n\">audioGraph</span><span class=\"p\">;</span>\n<span class=\"n\">NewAUGraph</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">audioGraph</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h4 id=\"2-aunode\">2.\u521b\u5efa\u5e76\u6dfb\u52a0 AUNode \u8282\u70b9</h4>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"c1\">/// IO \u64ad\u653e\u5355\u5143</span>\n\n<span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"bp\">AudioComponentDescription</span><span class=\"p\">)</span><span class=\"nf\">audioUnitDescription</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"bp\">AudioComponentDescription</span><span class=\"w\"> </span><span class=\"n\">outputUnitDescription</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">bzero</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">outputUnitDescription</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"bp\">AudioComponentDescription</span><span class=\"p\">));</span>\n<span class=\"w\">    </span><span class=\"n\">outputUnitDescription</span><span class=\"p\">.</span><span class=\"n\">componentType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitType_Output</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">outputUnitDescription</span><span class=\"p\">.</span><span class=\"n\">componentSubType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitSubType_RemoteIO</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">outputUnitDescription</span><span class=\"p\">.</span><span class=\"n\">componentManufacturer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitManufacturer_Apple</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">outputUnitDescription</span><span class=\"p\">.</span><span class=\"n\">componentFlags</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">outputUnitDescription</span><span class=\"p\">.</span><span class=\"n\">componentFlagsMask</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">outputUnitDescription</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">/// \u6df7\u5408 \u64ad\u653e\u5355\u5143</span>\n\n<span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"bp\">AudioComponentDescription</span><span class=\"p\">)</span><span class=\"nf\">mixUnitDescription</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"bp\">AudioComponentDescription</span><span class=\"w\"> </span><span class=\"n\">mixerUnitDescription</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">bzero</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">mixerUnitDescription</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"bp\">AudioComponentDescription</span><span class=\"p\">));</span>\n<span class=\"w\">    </span><span class=\"n\">mixerUnitDescription</span><span class=\"p\">.</span><span class=\"n\">componentType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitType_Mixer</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">mixerUnitDescription</span><span class=\"p\">.</span><span class=\"n\">componentSubType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitSubType_MultiChannelMixer</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">mixerUnitDescription</span><span class=\"p\">.</span><span class=\"n\">componentManufacturer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitManufacturer_Apple</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">mixerUnitDescription</span><span class=\"p\">.</span><span class=\"n\">componentFlags</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">mixerUnitDescription</span><span class=\"p\">.</span><span class=\"n\">componentFlagsMask</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">mixerUnitDescription</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">AUNode</span><span class=\"w\"> </span><span class=\"n\">audioNode</span><span class=\"p\">;</span>\n<span class=\"bp\">AudioComponentDescription</span><span class=\"w\"> </span><span class=\"n\">audioUnitDescription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">audioUnitDescription</span><span class=\"p\">];</span>\n<span class=\"n\">AUGraphAddNode</span><span class=\"p\">(</span><span class=\"n\">audioGraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">audioUnitDescription</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">audioNode</span><span class=\"p\">);</span>\n\n<span class=\"n\">AUNode</span><span class=\"w\"> </span><span class=\"n\">mixNode</span><span class=\"p\">;</span>\n<span class=\"bp\">AudioComponentDescription</span><span class=\"w\"> </span><span class=\"n\">mixUnitDescription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">mixUnitDescription</span><span class=\"p\">];</span>\n<span class=\"n\">AUGraphAddNode</span><span class=\"p\">(</span><span class=\"n\">audioGraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">mixUnitDescription</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">mixNode</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h4 id=\"3-augraph\">3.\u6253\u5f00 AUGraph</h4>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">AUGraphOpen</span><span class=\"p\">(</span><span class=\"n\">audioGraph</span><span class=\"p\">)</span>\n</code></pre></div>\n\n<h4 id=\"4\">4.\u521d\u59cb\u5316\u63a7\u5236\u5355\u5143</h4>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">AudioUnit</span><span class=\"w\"> </span><span class=\"n\">audioUnit</span><span class=\"p\">;</span>\n<span class=\"n\">AudioUnit</span><span class=\"w\"> </span><span class=\"n\">mixUnit</span><span class=\"p\">;</span>\n<span class=\"n\">AUGraphNodeInfo</span><span class=\"p\">(</span><span class=\"n\">audioGraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">audioNode</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">audioUnitDescription</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">audioUnit</span><span class=\"p\">);</span>\n<span class=\"n\">AUGraphNodeInfo</span><span class=\"p\">(</span><span class=\"n\">audioGraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mixNode</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mixUnitDescription</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mixUnit</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h4 id=\"5aunode\">5.AUNode \u8282\u70b9\u8fde\u63a5</h4>\n<div class=\"codehilite\"><pre><span></span><code>AUGraphConnectNodeInput(audioGraph, mixNode, 0, audioNode, 0);\n</code></pre></div>\n\n<h4 id=\"6\">6.\u8bbe\u5b9a\u8f93\u5165\u6e90</h4>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">OSStatus</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">noErr</span><span class=\"p\">;</span>\n<span class=\"c1\">/// \u8bbe\u7f6e\u97f3\u9891\u8f93\u51fa\u683c\u5f0f\u63cf\u8ff0</span>\n<span class=\"bp\">AudioStreamBasicDescription</span><span class=\"w\"> </span><span class=\"n\">destFormat</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">basicDescription</span><span class=\"p\">;</span>\n<span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AudioUnitSetProperty</span><span class=\"p\">(</span><span class=\"n\">mixUnit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitProperty_StreamFormat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitScope_Output</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">destFormat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">destFormat</span><span class=\"p\">));</span>\n<span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AudioUnitSetProperty</span><span class=\"p\">(</span><span class=\"n\">mixUnit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitProperty_StreamFormat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitScope_Input</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">destFormat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">destFormat</span><span class=\"p\">));</span>\n\n<span class=\"c1\">/// \u5355\u5143\u8f93\u51fa\u8bbe\u7f6e</span>\n<span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">maxFPS</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">4096</span><span class=\"p\">;</span>\n<span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AudioUnitSetProperty</span><span class=\"p\">(</span><span class=\"n\">mixUnit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitProperty_MaximumFramesPerSlice</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioUnitScope_Global</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"o\">&amp;</span><span class=\"n\">maxFPS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">maxFPS</span><span class=\"p\">));</span>\n<span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AudioUnitAddPropertyListener</span><span class=\"p\">(</span><span class=\"n\">mixUnit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">kAudioOutputUnitProperty_IsRunning</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">AudioUnitPropertyListenerProc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">__bridge</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"nb\">self</span><span class=\"p\">));</span>\n\n<span class=\"c1\">/// \u6e32\u67d3\u97f3\u9891</span>\n<span class=\"bp\">AURenderCallbackStruct</span><span class=\"w\"> </span><span class=\"n\">callbackStruct</span><span class=\"p\">;</span>\n<span class=\"n\">callbackStruct</span><span class=\"p\">.</span><span class=\"n\">inputProcRefCon</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">__bridge</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"nb\">self</span><span class=\"p\">);</span>\n<span class=\"n\">callbackStruct</span><span class=\"p\">.</span><span class=\"n\">inputProc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AURenderCallback</span><span class=\"p\">;</span>\n<span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AUGraphSetNodeInputCallback</span><span class=\"p\">(</span><span class=\"n\">audioGraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mixNode</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">callbackStruct</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h4 id=\"7-augraph\">7.\u521d\u59cb\u5316 AUGraph</h4>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">AUGraphInitialize</span><span class=\"p\">(</span><span class=\"n\">audioGraph</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h3 id=\"augraph_1\">AUGraph \u64ad\u653e</h3>\n<h4 id=\"1audiounitpropertylistenerproc\">1.AudioUnitPropertyListenerProc</h4>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">AudioUnitPropertyListenerProc</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">inRefCon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">AudioUnit</span><span class=\"w\"> </span><span class=\"n\">inUnit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">AudioUnitPropertyID</span><span class=\"w\"> </span><span class=\"n\">inID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">AudioUnitScope</span><span class=\"w\"> </span><span class=\"n\">inScope</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">AudioUnitElement</span><span class=\"w\"> </span><span class=\"n\">inElement</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"p\">...</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n<ul>\n<li>inRefCon: \u4e0a\u4e0b\u6587\u5bf9\u8c61.</li>\n<li>inUnit: \u76d1\u542c\u7684 AudioUnit.</li>\n<li>inID: \u76d1\u542c\u7684\u5c5e\u6027</li>\n<li>inScope: \u5c5e\u6027\u6240\u5c5e\u7684\u8303\u56f4\uff0c\u4f8b\u5982\u5168\u5c40\u8303\u56f4\u3001\u8f93\u5165\u8303\u56f4\u6216\u8f93\u51fa\u8303\u56f4\u7b49.</li>\n<li>inElement: \u5c5e\u6027\u6240\u5c5e\u7684\u5143\u7d20\uff0c\u7528\u4e8e\u6307\u5b9a\u5c5e\u6027\u4f5c\u7528\u7684\u5177\u4f53\u5143\u7d20\uff0c\u5982\u8f93\u5165\u901a\u9053\u3001\u8f93\u51fa\u901a\u9053\u7b49.</li>\n</ul>\n<p><strong>AudioUnitPropertyListenerProc</strong>\u662f\u4e00\u4e2a\u56de\u8c03\u51fd\u6570\uff0c\u7528\u4e8e\u5728 Audio Unit \u5c5e\u6027\u53d1\u751f\u53d8\u5316\u65f6\u63a5\u6536\u901a\u77e5\u3002\u5f53\u6ce8\u518c\u4e86\u8be5\u56de\u8c03\u51fd\u6570\u540e\uff0c\u5f53\u6307\u5b9a\u7684\u97f3\u9891\u5355\u5143\u5c5e\u6027\u53d1\u751f\u66f4\u6539\u65f6\uff0c\u7cfb\u7edf\u4f1a\u8c03\u7528\u8fd9\u4e2a\u56de\u8c03\u51fd\u6570\u6765\u901a\u77e5\u5e94\u7528\u7a0b\u5e8f\u3002</p>\n<h4 id=\"2aurendercallback\">2.AURenderCallback</h4>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">OSStatus</span><span class=\"w\"> </span><span class=\"nf\">AURenderCallback</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">userData</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">AudioUnitRenderActionFlags</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ioActionFlags</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"bp\">AudioTimeStamp</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">inTimeStamp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">inBusNumber</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">inNumberFrames</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"bp\">AudioBufferList</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ioData</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"p\">...</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n<ul>\n<li>userData: \u4e0a\u4e0b\u6587\u5bf9\u8c61.</li>\n<li>ioActionFlags: \u4e00\u4e2a\u6307\u5411\u6807\u5fd7\u4f4d\u7684\u6307\u9488\uff0c\u7528\u4e8e\u6307\u793a\u97f3\u9891\u5355\u5143\u7684\u64cd\u4f5c\u72b6\u6001\u3002</li>\n<li>inTimeStamp: \u5305\u542b\u6709\u5173\u5f53\u524d\u97f3\u9891\u5e27\u65f6\u95f4\u4fe1\u606f\u7684\u7ed3\u6784\u4f53\u3002</li>\n<li>inBusNumber: \u6307\u5b9a\u4e86\u97f3\u9891\u5355\u5143\u7684\u603b\u7ebf\u53f7\u7801\uff0c\u7528\u4e8e\u786e\u5b9a\u54ea\u4e2a\u8f93\u5165\u6216\u8f93\u51fa\u603b\u7ebf\u6b63\u5728\u8fdb\u884c\u5904\u7406\u3002</li>\n<li>inNumberFrames: \u6307\u5b9a\u8981\u5904\u7406\u7684\u97f3\u9891\u5e27\u6570\u3002</li>\n<li>ioData: \u4e00\u4e2a\u6307\u5411\u97f3\u9891\u7f13\u51b2\u533a\u5217\u8868\u7684\u6307\u9488\uff0c\u5305\u542b\u4e86\u8f93\u5165\u548c\u8f93\u51fa\u97f3\u9891\u6570\u636e\u3002</li>\n</ul>\n<p><strong>AURenderCallback</strong> \u662f\u97f3\u9891\u6e32\u67d3\u56de\u8c03\u51fd\u6570, \u5728\u6b64\u6211\u4eec\u9700\u8981\u63d0\u4f9b\u97f3\u9891\u6570\u636e\u7ed9 ioData \u624d\u80fd\u8fdb\u884c\u64ad\u653e.</p>\n<h4 id=\"3-iodata\">3.\u63d0\u4f9b\u97f3\u9891\u6570\u636e\u7ed9 ioData</h4>\n<p>\u9996\u5148\u6211\u4eec\u9700\u8981\u4f7f\u7528 <strong>AudioFileStream</strong> \u5bf9\u97f3\u9891\u6570\u636e\u6d41\u8fdb\u884c\u5206\u79bb\u97f3\u9891\u5e27. </p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">AudioFileStreamParseBytes</span><span class=\"p\">(</span><span class=\"n\">_audioFileStreamID</span><span class=\"p\">,(</span><span class=\"kt\">UInt32</span><span class=\"p\">)[</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"p\">],[</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"c1\">/// \u8f93\u51fa\u5206\u79bb\u7684\u97f3\u9891\u5e27\u6570\u636e</span>\n<span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">audio_file_stream_packets_proc</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">inClientData</span><span class=\"p\">,</span>\n<span class=\"w\">                                           </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">inNumberBytes</span><span class=\"p\">,</span>\n<span class=\"w\">                                           </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"n\">inNumberPackets</span><span class=\"p\">,</span>\n<span class=\"w\">                                           </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">inInputData</span><span class=\"p\">,</span>\n<span class=\"w\">                                           </span><span class=\"bp\">AudioStreamPacketDescription</span><span class=\"w\">    </span><span class=\"o\">*</span><span class=\"n\">inPacketDescriptions</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">/// inInputData \u97f3\u9891\u5e27\u6570\u636e</span>\n<span class=\"w\">    </span><span class=\"c1\">// inNumberPackets \u97f3\u9891\u5e27\u6570\u91cf</span>\n<span class=\"w\">    </span><span class=\"c1\">// inPacketDescriptions \u97f3\u9891\u5e27\u4fe1\u606f,\u5305\u542b\u6570\u636e\u5b57\u8282\u8d77\u59cb\u4f4d\u7f6e\u548c\u957f\u5ea6.</span>\n<span class=\"w\">    </span><span class=\"p\">...</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n<p>\u5728\u5f97\u5230\u97f3\u9891\u5e27\u540e, \u4f7f\u7528 <strong>AudioConverter</strong> \u5c06\u97f3\u9891\u5e27\u4ece\u538b\u7f29\u683c\u5f0f\u8f6c\u4e3a PCM \u683c\u5f0f\u6570\u636e.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">AudioConverterFillComplexBuffer</span><span class=\"p\">(</span><span class=\"n\">_audioConverter</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">input_data_proc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">__bridge</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"nb\">self</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">inNumberFrames</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ioData</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">);</span>\n\n<span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">OSStatus</span><span class=\"w\"> </span><span class=\"nf\">input_data_proc</span><span class=\"p\">(</span><span class=\"n\">AudioConverterRef</span><span class=\"w\"> </span><span class=\"n\">inAudioConverter</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">UInt32</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ioNumberDataPackets</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"bp\">AudioBufferList</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ioData</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"bp\">AudioStreamPacketDescription</span><span class=\"w\"> </span><span class=\"o\">**</span><span class=\"n\">outDataPacketDescription</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">inUserData</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">/// \u4f2a\u4ee3\u7801</span>\n<span class=\"w\">    </span><span class=\"c1\">/// inInputData &lt;- audio_file_stream_packets_proc</span>\n<span class=\"w\">    </span><span class=\"c1\">/// inPacketDescriptions &lt;- audio_file_stream_packets_proc</span>\n<span class=\"w\">    </span><span class=\"n\">ioData</span><span class=\"o\">-&gt;</span><span class=\"n\">mBuffers</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">mData</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">inInputData</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"n\">ioData</span><span class=\"o\">-&gt;</span><span class=\"n\">mBuffers</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">mDataByteSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">inInputData</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"n\">ioData</span><span class=\"o\">-&gt;</span><span class=\"n\">mBuffers</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">mNumberChannels</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">outDataPacketDescription</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"o\">*</span><span class=\"n\">outDataPacketDescription</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">inPacketDescriptions</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">noErr</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n<h4 id=\"4_1\">4.\u5f00\u59cb\u64ad\u653e</h4>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">AUGraphStart</span><span class=\"p\">(</span><span class=\"n\">audioGraph</span><span class=\"p\">);</span>\n<span class=\"n\">AudioOutputUnitStart</span><span class=\"p\">(</span><span class=\"n\">audioUnit</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h4 id=\"5\">5.\u505c\u6b62\u64ad\u653e</h4>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">OSStatus</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AUGraphIsRunning</span><span class=\"p\">(</span><span class=\"n\">audioGraph</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">isRunning</span><span class=\"p\">);</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">noErr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">isRunning</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">AUGraphStop</span><span class=\"p\">(</span><span class=\"n\">audioGraph</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">noErr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>"}