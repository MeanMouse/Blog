{"title": "Runtime \u63a2\u7a76", "date": "2018-12-19 11:00:51", "categories": "iOS", "tags": "Runtime", "keywords": "Runtime,\u6d88\u606f\u8f6c\u53d1\u673a\u5236,Runtime\u7684\u5e94\u7528,Swizzling", "description": "", "images": "https://lianghuii.com/postCover/runtime\u63a2\u7a76.png", "file_name": "Runtime-\u63a2\u7a76", "short": " \u5bf9\u4e8e Runtime \u7684\u4e86\u89e3\u4e00\u76f4\u5f88\u5c11\uff0c\u9762\u8bd5\u7684\u65f6\u5019\uff0c\u603b\u662f\u4f1a\u63d0\u53ca\uff0c\u56e0\u6b64\u5f00\u59cb\u53bb\u4e86\u89e3 Runtime\u3002\u5728\u7f51\u4e0a\u627e\u5bfb\u8fd9\u7c7b\u8d44\u6599\u548c\u6587\u7ae0\u5e76\u5f00\u59cb\u8be6\u8bfb\uff0c\u5728\u8be6\u8bfb\u540e\u5bf9\u4e8e Runtime \u6709\u4e86\u66f4\u6df1\u4e86\u89e3\uff0c\u4f46\u662f\u6709\u4e9b\u5730\u65b9\u4ecd\u6709\u4e9b\u6a21\u7cca\uff0c\u8fd9\u6837\u534a\u77e5\u534a\u89e3\u7684\u72b6\u6001\u53ef\u4e0d\u662f\u597d\u4e8b\uff0c\u56e0\u6b64\u6211\u901a\u8fc7\u77e5\u8bc6\u6574\u7406\uff0c\u6a21\u62df\u5411\u4eba\u8bb2\u8ff0\u7684\u65b9\u5f0f\uff0c\u4ee5\u67e5\u89e3\u81ea\u5df1\u7684\u6a21\u7cca\u4e4b\u5904\u3002\u82e5\u6574\u7406\u7684\u6709\u8bef\u4e4b\u5904\uff0c\u671b\u5404\u4f4d\u5927\u795e\u6307\u51fa\uff0c\u8c22\u8c22\uff01 \n ", "content": "<p>\u5bf9\u4e8e Runtime \u7684\u4e86\u89e3\u4e00\u76f4\u5f88\u5c11\uff0c\u9762\u8bd5\u7684\u65f6\u5019\uff0c\u603b\u662f\u4f1a\u63d0\u53ca\uff0c\u56e0\u6b64\u5f00\u59cb\u53bb\u4e86\u89e3 Runtime\u3002\u5728\u7f51\u4e0a\u627e\u5bfb\u8fd9\u7c7b\u8d44\u6599\u548c\u6587\u7ae0\u5e76\u5f00\u59cb\u8be6\u8bfb\uff0c\u5728\u8be6\u8bfb\u540e\u5bf9\u4e8e Runtime \u6709\u4e86\u66f4\u6df1\u4e86\u89e3\uff0c\u4f46\u662f\u6709\u4e9b\u5730\u65b9\u4ecd\u6709\u4e9b\u6a21\u7cca\uff0c\u8fd9\u6837\u534a\u77e5\u534a\u89e3\u7684\u72b6\u6001\u53ef\u4e0d\u662f\u597d\u4e8b\uff0c\u56e0\u6b64\u6211\u901a\u8fc7\u77e5\u8bc6\u6574\u7406\uff0c\u6a21\u62df\u5411\u4eba\u8bb2\u8ff0\u7684\u65b9\u5f0f\uff0c\u4ee5\u67e5\u89e3\u81ea\u5df1\u7684\u6a21\u7cca\u4e4b\u5904\u3002\u82e5\u6574\u7406\u7684\u6709\u8bef\u4e4b\u5904\uff0c\u671b\u5404\u4f4d\u5927\u795e\u6307\u51fa\uff0c\u8c22\u8c22\uff01</p>\n<!-- more -->\n<h3 id=\"runtime\">Runtime \u7b80\u4ecb</h3>\n<blockquote>\n<p>Runtime \u53c8\u53eb\u8fd0\u884c\u65f6\uff0c\u662f\u4e00\u5957\u7528 C \u548c \u6c47\u7f16\u7f16\u8bed\u8a00 \u5199\u7684 API\u5e93\u3002Objective-C \u6269\u5c55\u4e86 C \u8bed\u8a00\uff0c\u5e76\u52a0\u5165\u4e86\u9762\u5411\u5bf9\u8c61\u7279\u6027\u548c Smalltalk \u5f0f\u7684\u6d88\u606f\u4f20\u9012\u673a\u5236\uff0c\u4f7f\u5f97 Objective-C \u5177\u6709\u9762\u5411\u5bf9\u8c61\u548c\u52a8\u6001\u673a\u5236\u7684\u7279\u6027\uff0c\u8fd9\u4e24\u4e2a\u7279\u6027\u4fbf\u662f\u7528 Runtime \u6765\u5b9e\u73b0\u7684\u3002</p>\n<p>Runtime\u5176\u5b9e\u6709\u4e24\u4e2a\u7248\u672c: \u201cmodern\u201d \u548c \u201clegacy\u201d\u3002\u6211\u4eec\u73b0\u5728\u7528\u7684 Objective-C 2.0 \u91c7\u7528\u7684\u662f\u73b0\u884c (Modern) \u7248\u7684 Runtime \u7cfb\u7edf\uff0c\u53ea\u80fd\u8fd0\u884c\u5728 iOS \u548c macOS 10.5 \u4e4b\u540e\u7684 64 \u4f4d\u7a0b\u5e8f\u4e2d\u3002\u800c macOS \u8f83\u8001\u768432\u4f4d\u7a0b\u5e8f\u4ecd\u91c7\u7528 Objective-C 1 \u4e2d\u7684\uff08\u65e9\u671f\uff09Legacy \u7248\u672c\u7684 Runtime \u7cfb\u7edf\u3002\u8fd9\u4e24\u4e2a\u7248\u672c\u6700\u5927\u7684\u533a\u522b\u5728\u4e8e\u5f53\u4f60\u66f4\u6539\u4e00\u4e2a\u7c7b\u7684\u5b9e\u4f8b\u53d8\u91cf\u7684\u5e03\u5c40\u65f6\uff0c\u5728\u65e9\u671f\u7248\u672c\u4e2d\u4f60\u9700\u8981\u91cd\u65b0\u7f16\u8bd1\u5b83\u7684\u5b50\u7c7b\uff0c\u800c\u73b0\u884c\u7248\u5c31\u4e0d\u9700\u8981\u3002</p>\n<p>Runtime \u57fa\u672c\u662f\u7528 C \u548c\u6c47\u7f16\u5199\u7684\uff0c\u53ef\u89c1\u82f9\u679c\u4e3a\u4e86\u52a8\u6001\u7cfb\u7edf\u7684\u9ad8\u6548\u800c\u4f5c\u51fa\u7684\u52aa\u529b\u3002\u4f60\u53ef\u4ee5\u5728<a href=\"https://opensource.apple.com/source/objc4/\">\u8fd9\u91cc</a>\u67e5\u770b\u82f9\u679c\u7ef4\u62a4\u7684\u5f00\u6e90\u4ee3\u7801\uff0c\u53e6\u5916\u53ef\u4ee5\u4ece<a href=\"https://opensource.apple.com/tarballs/objc4/\">\u6b64\u5904</a>\u4e0b\u8f7d\u5bf9\u5e94\u7248\u672c\u538b\u7f29\u5305\u3002\u82f9\u679c\u548cGNU\u5404\u81ea\u7ef4\u62a4\u4e00\u4e2a\u5f00\u6e90\u7684 runtime \u7248\u672c\uff0c\u8fd9\u4e24\u4e2a\u7248\u672c\u4e4b\u95f4\u90fd\u5728\u52aa\u529b\u7684\u4fdd\u6301\u4e00\u81f4\u3002</p>\n</blockquote>\n<h3 id=\"nsobject\">NSObject</h3>\n<p>\u6839\u636e\u6e90\u7801\u53ef\u4ee5\u770b\u5230 NSObject \u7684\u5b9a\u4e49</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_class</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"kt\">Class</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"k\">@interface</span> <span class=\"bp\">NSObject</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"bp\">NSObject</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">Class</span><span class=\"w\"> </span><span class=\"n\">isa</span><span class=\"w\">  </span><span class=\"n\">OBJC_ISA_AVAILABILITY</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"c1\">// objc.h \u4e2d NSObject\u5bf9\u5e94\u7684\u7ed3\u6784\u4f53</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_object</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">Class</span><span class=\"w\"> </span><span class=\"n\">isa</span><span class=\"w\">  </span><span class=\"n\">OBJC_ISA_AVAILABILITY</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n\n<span class=\"c1\">// objc_object \u7ed3\u6784\u4f53\u7684\u5b9e\u73b0</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_object</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">private</span><span class=\"o\">:</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">isa_t</span><span class=\"w\"> </span><span class=\"n\">isa</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">...</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u5728 objc_object \u4e2d \u6709\u4e00\u4e2a\u6307\u5411 Class \u7684 isa \u6307\u9488\uff0c\u5373 objc_object \u7684\u7c7b\u3002</p>\n<h4 id=\"isa\">isa</h4>\n<p>isa\u6307\u9488 \u662f\u4e00\u4e2a union \u8054\u5408\u4f53\u5b9e\u4f8b\uff0c\u5982\u4e0b\uff1a </p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"nc\">isa_t</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">isa_t</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">isa_t</span><span class=\"p\">(</span><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"kt\">Class</span><span class=\"w\"> </span><span class=\"n\">cls</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"cp\">#if defined(ISA_BITFIELD)</span>\n<span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">ISA_BITFIELD</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// defined in isa.h</span>\n<span class=\"w\">  </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"cp\">#endif</span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n\n<span class=\"c1\">// ISA_BITFIELD \u5b8f</span>\n<span class=\"cp\">#   define ISA_BITFIELD                                                        \\</span>\n<span class=\"cp\">uintptr_t nonpointer        : 1;                                         \\</span>\n<span class=\"cp\">uintptr_t has_assoc         : 1;                                         \\</span>\n<span class=\"cp\">uintptr_t has_cxx_dtor      : 1;                                         \\</span>\n<span class=\"cp\">uintptr_t shiftcls          : 44; </span><span class=\"cm\">/*MACH_VM_MAX_ADDRESS 0x7fffffe00000*/</span><span class=\"cp\"> \\</span>\n<span class=\"cp\">uintptr_t magic             : 6;                                         \\</span>\n<span class=\"cp\">uintptr_t weakly_referenced : 1;                                         \\</span>\n<span class=\"cp\">uintptr_t deallocating      : 1;                                         \\</span>\n<span class=\"cp\">uintptr_t has_sidetable_rc  : 1;                                         \\</span>\n<span class=\"cp\">uintptr_t extra_rc          : 8</span>\n</code></pre></div>\n\n<p>\u8981\u4e86\u89e3 isa \u7684\u5b9e\u73b0\u53ef\u770b <a href=\"https://github.com/draveness/analyze/blob/master/contents/objc/\u4ece%20NSObject%20\u7684\u521d\u59cb\u5316\u4e86\u89e3%20isa.md#shiftcls\">\u4ece NSObject \u7684\u521d\u59cb\u5316\u4e86\u89e3 isa</a></p>\n<h4 id=\"objc_class\">objc_class</h4>\n<p>Class \u662f\u4e00\u4e2a struct objc_class \u7684\u7ed3\u6784\u4f53\u5b9e\u4f8b\uff0cobjc_class \u7684\u5b9a\u4e49\u5982\u4e0b\uff1a</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_class</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">Class</span><span class=\"w\"> </span><span class=\"n\">isa</span><span class=\"w\">  </span><span class=\"n\">OBJC_ISA_AVAILABILITY</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"cp\">#if !__OBJC2__</span>\n<span class=\"w\">  </span><span class=\"kt\">Class</span><span class=\"w\"> </span><span class=\"n\">super_class</span><span class=\"w\">                                        </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">name</span><span class=\"w\">                                         </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">long</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\">                                             </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">long</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\">                                                </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">long</span><span class=\"w\"> </span><span class=\"n\">instance_size</span><span class=\"w\">                                       </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_ivar_list</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ivars</span><span class=\"w\">                             </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_method_list</span><span class=\"w\"> </span><span class=\"o\">**</span><span class=\"n\">methodLists</span><span class=\"w\">                    </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_cache</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">cache</span><span class=\"w\">                                 </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_protocol_list</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">protocols</span><span class=\"w\">                     </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"cp\">#endif</span>\n\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"cm\">/* Use `Class` instead of `struct objc_class *` */</span><span class=\"w\"></span>\n\n<span class=\"c1\">// objc_class \u7ed3\u6784\u4f53\u5b9e\u73b0</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_class</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">objc_object</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"c1\">// Class ISA;</span>\n<span class=\"w\">  </span><span class=\"kt\">Class</span><span class=\"w\"> </span><span class=\"n\">superclass</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">cache_t</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"p\">;</span><span class=\"w\">             </span><span class=\"c1\">// formerly cache pointer and vtable</span>\n<span class=\"w\">  </span><span class=\"n\">class_data_bits_t</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"p\">;</span><span class=\"w\">    </span><span class=\"c1\">// class_rw_t * plus custom rr/alloc flags</span>\n<span class=\"w\">  </span><span class=\"p\">...</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>objc_class \u4e2d\u6709\u6307\u5411\u7236\u7c7b\u7684\u6307\u9488\u3001\u7c7b\u540d\u3001\u7248\u672c\u3001\u5b9e\u4f8b\u7684\u5927\u5c0f\u3001\u5b9e\u4f8b\u53d8\u91cf\u5217\u8868\u3001\u65b9\u6cd5\u5217\u8868\u3001\u7f13\u5b58\u3001\u9075\u5b88\u7684\u534f\u8bae\u5217\u8868\uff0c\u53ef\u89c1\u7c7b\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a objc_class \u7ed3\u6784\u4f53\u5b9e\u4f8b\u4e5f\u662f\u4e00\u4e2a\u5bf9\u8c61\u3002</p>\n<h4 id=\"meta-class\">Meta Class</h4>\n<p>\u5728 objc_class \u4e2d\u4e5f\u6709\u4e00\u4e2a isa \u6307\u9488\uff0c\u8fd9\u4e2a isa \u6307\u9488\u6307\u5411\u7684\u662f Meta Class\uff08\u5143\u7c7b\uff09\uff0c\u8be5\u7c7b\u4fdd\u5b58\u4e86\u521b\u5efa\u7c7b\u5bf9\u8c61\u4ee5\u53ca\u7c7b\u65b9\u6cd5\u6240\u9700\u7684\u6240\u6709\u4fe1\u606f\u3002\u5143\u7c7b\u4e5f\u662f\u4e00\u4e2a\u5bf9\u8c61\uff0c\u53ef\u4ee5\u5411\u5143\u7c7b\u53d1\u9001\u6d88\u606f\uff0c\u6b64\u7c7b\u6d88\u606f\u4fbf\u662f\u7c7b\u65b9\u6cd5\uff08\u5e26 \u201c+\u201d \u7684\u65b9\u6cd5\uff09\u3002\u6bcf\u4e2a\u7c7b\u90fd\u4f1a\u6709\u4e00\u4e2a\u5355\u72ec\u5bf9\u5e94\u7684\u5143\u7c7b\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u7c7b\u53ea\u6709\u4e00\u4e2amethodLists\uff0c\u65b9\u6cd5\u4e0d\u80fd\u91cd\u540d\uff0c\u56e0\u6b64\u9700\u8981\u6709\u4e00\u4e2a\u7c7b\u6765\u4fdd\u5b58\u7c7b\u65b9\u6cd5\u3002\u5176\u4e2d\u5bf9\u5e94\u5173\u7cfb\u5982\u4e0b\u56fe\uff1a<br />\n<img alt=\"\" src=\"https://upload-images.jianshu.io/upload_images/1194012-d7b097e86f9e488d.png?imageMogr2/auto-orient/strip|imageView2/2/w/625/format/webp\" /></p>\n<ul>\n<li>\u6bcf\u4e2a\u5bf9\u8c61(instance)\u7684 isa \u6307\u9488\u6307\u5411\u5bf9\u8c61\u7c7b(class)\uff0c\u800c\u5bf9\u8c61\u7c7b\u6307\u5411\u552f\u4e00\u7684\u5143\u7c7b(meta class)\u3002</li>\n<li>\u6bcf\u4e2a\u7c7b\u90fd\u6709\u6307\u5411\u7236\u7c7b\u7684\u6307\u9488\uff0cclass -&gt; superClass\u3001class\u7684meta class -&gt; superClass \u7684 meta class\u3002</li>\n<li>\u6bcf\u4e2ameta class \u90fd\u6307\u5411 Root meta class</li>\n<li>Root class \u4fbf\u662f NSObject\uff0cNSObject \u6ca1\u6709\u8d85\u7c7b\uff0c\u6240\u4ee5\u6307\u5411 nil\uff0c Root meta class \u6307\u5411 NSObject\uff0c\u5f62\u6210\u95ed\u73af\u3002</li>\n</ul>\n<p>\u5728main\u65b9\u6cd5\u6267\u884c\u4e4b\u524d\uff0c\u4ece dyld\u5230runtime\u8fd9\u671f\u95f4\uff0c\u7c7b\u5bf9\u8c61\u548c\u5143\u7c7b\u5bf9\u8c61\u88ab\u521b\u5efa\uff0c\u5177\u4f53\u8be6\u7ec6\u53ef\u770b <a href=\"http://blog.sunnyxx.com/2014/08/30/objc-pre-main/\">iOS \u7a0b\u5e8f main \u51fd\u6570\u4e4b\u524d\u53d1\u751f\u4e86\u4ec0\u4e48</a></p>\n<h4 id=\"method\">method</h4>\n<p>method \u5728 Objective-C \u4e2d\u79f0\u4e3a\u65b9\u6cd5\uff0c\u5728 C \u8bed\u8a00\u79f0\u4e3a\u51fd\u6570\uff0c\u8868\u793a\u80fd\u591f\u72ec\u7acb\u5b8c\u6210\u4e00\u4e2a\u529f\u80fd\u7684\u4e00\u6bb5\u4ee3\u7801\uff0cmethod \u7684\u6e90\u7801\u5b9a\u4e49\u5982\u4e0b\uff1a</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_method</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">Method</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_method</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">SEL</span><span class=\"w\"> </span><span class=\"n\">method_name</span><span class=\"w\">                                          </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">method_types</span><span class=\"w\">                                       </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">IMP</span><span class=\"w\"> </span><span class=\"n\">method_imp</span><span class=\"w\">                                           </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"c1\">// objc_method \u5b9e\u73b0</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">method_t</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">SEL</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">types</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">IMP</span><span class=\"w\"> </span><span class=\"n\">imp</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">SortBySELAddress</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">public</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">binary_function</span><span class=\"o\">&lt;</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">method_t</span><span class=\"o\">&amp;</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">method_t</span><span class=\"o\">&amp;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"nf\">operator</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">method_t</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">method_t</span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>method \u662f\u4e00\u4e2a objc_method \u7ed3\u6784\u4f53\u5b9e\u4f8b\uff0c\u7ed3\u6784\u4f53\u4e2d\u6709\uff1a\u65b9\u6cd5\u540d\u3001\u65b9\u6cd5\u7c7b\u578b\u3001\u65b9\u6cd5\u5b9e\u73b0\u7684\u5185\u5b58\u5730\u5740 \u4e09\u4e2a\u5c5e\u6027\u3002</p>\n<h5 id=\"sel\">SEL</h5>\n<p>SEL \u7684\u6e90\u7801\u5b9a\u4e49\uff1a</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"c1\">/// An opaque type that represents a method selector.</span>\n<span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_selector</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"kt\">SEL</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>SEL \u662f selector \u5728 Objective-C \u4e2d\u7684\u8868\u793a\u7c7b\u578b\uff08Swift\u4e2d\u662fSelector\u7c7b\uff09\u3002SEL \u662f\u4e00\u4e2a objc_selector \u7ed3\u6784\u4f53\u5b9e\u4f8b\uff0c\u800c objc_selector \u662f\u4e00\u4e2a\u6620\u5c04\u5230\u65b9\u6cd5\u7684C\u5b57\u7b26\u4e32\u3002selector \u662f\u4e00\u4e2a\u4ee5\u65b9\u6cd5\u540d\u4e3a\u533a\u5206\u7684\u9009\u62e9\u5668\uff0c\u4e0d\u540c\u7c7b\u4e2d\u76f8\u540c\u540d\u5b57\u7684\u65b9\u6cd5\u5bf9\u5e94\u7684\u65b9\u6cd5\u9009\u62e9\u5668\u662f\u4e00\u6837\u7684\uff0c\u5373\u4f7f\u65b9\u6cd5\u540d\u5b57\u76f8\u540c\u800c\u53d8\u91cf\u7c7b\u578b\u4e0d\u540c\u4e5f\u4f1a\u5bfc\u81f4\u5b83\u4eec\u5177\u6709\u76f8\u540c\u7684\u65b9\u6cd5\u9009\u62e9\u5668\uff0c\u56e0\u6b64\u8fd9\u4e5f\u5bfc\u81f4 Objective-C \u4e0d\u652f\u6301\u65b9\u6cd5\u91cd\u8f7d\u3002</p>\n<h5 id=\"imp\">IMP</h5>\n<p>IMP \u7684\u6e90\u7801\u5b9a\u4e49\uff1a</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"c1\">/// A pointer to the function of a method implementation. </span>\n<span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"kt\">IMP</span><span class=\"p\">)(</span><span class=\"kt\">id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">SEL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">...);</span><span class=\"w\"> </span>\n</code></pre></div>\n\n<p>\u8be5\u6307\u9488\u6307\u5411\u65b9\u6cd5\u5b9e\u73b0\u7684\u5185\u5b58\u5730\u5740</p>\n<h5 id=\"types\">types</h5>\n<p>Type Encoding\u7c7b\u578b\u7f16\u7801\uff0c\u5177\u4f53\u53ef\u770b <a href=\"https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html\">\u5b98\u65b9\u6587\u6863</a></p>\n<p>\u6709\u5174\u8da3\u6df1\u5165\u4e86\u89e3objc\u7684\u65b9\u6cd5\u7ed3\u6784\u53ef\u770b <a href=\"https://github.com/draveness/analyze/blob/master/contents/objc/\u6df1\u5165\u89e3\u6790%20ObjC%20\u4e2d\u65b9\u6cd5\u7684\u7ed3\u6784.md#\u6df1\u5165\u89e3\u6790-objc-\u4e2d\u65b9\u6cd5\u7684\u7ed3\u6784\">\u6df1\u5165\u89e3\u6790 ObjC \u4e2d\u65b9\u6cd5\u7684\u7ed3\u6784</a></p>\n<h4 id=\"objc_cache\">objc_cache</h4>\n<p>objc_cache \u7684\u6e90\u7801\u5b9a\u4e49\uff1a</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_cache</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">mask</span><span class=\"w\"> </span><span class=\"cm\">/* total = mask + 1 */</span><span class=\"w\">                 </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">occupied</span><span class=\"w\">                                    </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">Method</span><span class=\"w\"> </span><span class=\"n\">buckets</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\">                                        </span><span class=\"n\">OBJC2_UNAVAILABLE</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n\n<span class=\"c1\">// objc_cache \u5b9e\u73b0</span>\n<span class=\"cp\">#if __LP64__</span>\n<span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">mask_t</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// x86_64 &amp; arm64 asm are less efficient with 16-bits</span>\n<span class=\"cp\">#else</span>\n<span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">mask_t</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"cp\">#endif</span>\n\n<span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"kt\">uintptr_t</span><span class=\"w\"> </span><span class=\"n\">cache_key_t</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">cache_t</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"c1\">// \u8bb0\u5f55\u65b9\u6cd5\u540d\u5bf9\u5e94\u7684\u65b9\u6cd5\u5b9e\u73b0 IMP</span>\n<span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">bucket_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">_buckets</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"c1\">// \u5206\u914d\u7528\u6765\u7f13\u5b58bucket\u7684\u603b\u6570</span>\n<span class=\"w\">  </span><span class=\"n\">mask_t</span><span class=\"w\"> </span><span class=\"n\">_mask</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"c1\">// \u8868\u660e\u76ee\u524d\u5b9e\u9645\u5360\u7528\u7684\u7f13\u5b58bucket\u7684\u4e2a\u6570\u3002</span>\n<span class=\"w\">  </span><span class=\"n\">mask_t</span><span class=\"w\"> </span><span class=\"n\">_occupied</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">bucket_t</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"c1\">// \u65b9\u6cd5\u540d</span>\n<span class=\"w\">  </span><span class=\"n\">cache_key_t</span><span class=\"w\"> </span><span class=\"n\">_key</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"c1\">// \u65b9\u6cd5\u5b9e\u73b0\u5185\u5b58\u5730\u5740</span>\n<span class=\"w\">  </span><span class=\"kt\">IMP</span><span class=\"w\"> </span><span class=\"n\">_imp</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u5f53\u65b9\u6cd5\u8c03\u7528\u65f6\uff0c\u901a\u8fc7\u8c03\u7528\u8005isa\u6307\u9488\u83b7\u53d6\u8c03\u7528\u8005\u7684\u7c7b\uff0c\u7136\u540e\u5728\u7c7b\u7684 methodLists \u4e2d\u67e5\u627e\u65b9\u6cd5\u5b9e\u73b0\uff0c\u5982\u679c\u6ca1\u627e\u5230\u5219\u5f80\u4e0a\u7236\u7c7b\u4e2d\u67e5\u627e \uff0c\u8fd9\u6837\u7684\u8c03\u7528\u65b9\u5f0f\u4ee3\u4ef7\u6bd4\u8f83\u5927\u3002\u4e3a\u4e86\u4f18\u5316\u6548\u7387\uff0c\u4f1a\u9996\u5148\u53bb cache \u4e2d\u7f13\u5b58\u7684\u65b9\u6cd5\u4e2d\u67e5\u627e\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5c31\u5f00\u59cb\u904d\u5386\u7c7b\u7684\u65b9\u6cd5\u5217\u8868\uff0c\u627e\u5230\u540e\u4ee5 \u65b9\u6cd5\u540d\u4e3a key\uff0c\u65b9\u6cd5\u5b9e\u73b0 IMP \u4e3a value \u7f13\u5b58\u5230 cache\u4e2d\uff0c\u7b49\u4e0b\u6b21\u8c03\u7528\u5c31\u80fd\u52a0\u5feb\u8c03\u7528\u6548\u7387\u3002</p>\n<h3 id=\"_1\">\u6d88\u606f\u4f20\u9012</h3>\n<h4 id=\"_2\">\u6d88\u606f\u53d1\u9001</h4>\n<p>\u5728Objective-C \u4e2d\u65b9\u6cd5\u7684\u8c03\u7528\u5982\uff1a[receiver message]\uff0c\u5728\u7f16\u8bd1\u540e\u4f1a\u8f6c\u5316\u6210\u7528\u4e8e\u6d88\u606f\u53d1\u9001\u7684C\u51fd\u6570\u51fd\u6570\u5f62\u5f0f\uff0c\u5982\u4e0b\uff1a</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">objc_msgSend</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"cm\">/* id self, SEL op, ... */</span><span class=\"w\"> </span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u5f53objc_msgSend \u51fd\u6570\u8c03\u7528\u540e\u4f1a\u505a\u4ee5\u4e0b\u4e8b\u60c5\uff1a</p>\n<ol>\n<li>\u68c0\u67e5 selectors \u662f\u5426\u8981\u5ffd\u7565\u5982\uff1aGC selectors\uff08macOS\u4e2dGC\u5783\u573e\u56de\u6536\u673a\u5236\u7528\u5230\u7684\u65b9\u6cd5\uff09\u3002</li>\n<li>\u68c0\u67e5\u8c03\u7528\u8005\u662f\u5426\u4e3anil\uff0c\u5982\u679c\u4e3anil\u5219\u5ffd\u7565\u6b64\u6d88\u606f\u4e0d\u505a\u5904\u7406\u3002</li>\n<li>\u53bb class \u7684\u7f13\u5b58\u4e2d\u67e5\u627e\u8be5\u65b9\u6cd5\u7684\u5b9e\u73b0 IMP\uff0c\u5982\u679c\u627e\u5230\u4fbf\u5c06\u65b9\u6cd5\u540d\u548cIMP\u7f13\u5b58\u5230 cache \u4e2d\uff0c\u8c03\u7528\u8be5\u65b9\u6cd5\u3002\u5982\u679c\u6ca1\u627e\u5230\u4fbf\u53bb\u7236\u7c7b\u7684\u65b9\u6cd5\u5217\u8868\u4e2d\u67e5\u627e\uff0c\u4e00\u76f4\u627e\u5230\u6839\u7c7b NSObject \u90fd\u6ca1\u627e\u5230\u7684\u8bdd\u5c31\u5f00\u59cb\u8fdb\u5165\u6d88\u606f\u8f6c\u53d1\u9636\u6bb5\u3002</li>\n</ol>\n<p>\u6709\u7684\u65f6\u5019\uff0c\u6211\u4eec\u4f1a\u88ab\u8868\u9762\u8c03\u7528\u8005\u8ff7\u60d1\uff0c\u5982\uff1a</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">@implementation</span> <span class=\"nc\">Son</span> : <span class=\"nc\">Father</span><span class=\"w\"></span>\n<span class=\"n\">NSLog</span><span class=\"p\">(</span><span class=\"s\">@&quot;%@&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">NSStringFromClass</span><span class=\"p\">([</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"p\">]));</span><span class=\"w\"></span>\n<span class=\"n\">NSLog</span><span class=\"p\">(</span><span class=\"s\">@&quot;%@&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">NSStringFromClass</span><span class=\"p\">([</span><span class=\"nb\">super</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"p\">]));</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u770b\u8868\u9762\uff0c\u6211\u4eec\u4f1a\u4ee5\u4e3a\u7ed3\u679c\u662f\uff1aSon\u3001Father\uff0c\u4f46\u6b63\u786e\u7ed3\u679c\u662f Son\u3001Son\u3002self \u662f\u7c7b\u7684\u4e00\u4e2a\u9690\u85cf\u53c2\u6570\uff0c\u6bcf\u4e2a\u65b9\u6cd5\u7684\u5b9e\u73b0\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u5373\u4e3aself\uff0c\u4ee3\u8868\u5bf9\u8c61\u81ea\u8eab\uff0c<br />\n\u800c super \u5e76\u4e0d\u662f\u9690\u85cf\u53c2\u6570\uff0c\u5b83\u5b9e\u9645\u4e0a\u53ea\u662f\u4e00\u4e2a\u201d\u7f16\u8bd1\u5668\u6807\u793a\u7b26\u201d\uff0c\u5b83\u8d1f\u8d23\u544a\u8bc9\u7f16\u8bd1\u5668\uff0c\u5f53\u8c03\u7528\u65b9\u6cd5\u65f6\uff0c\u4ee5 self \u53bb\u8c03\u7528\u7236\u7c7b\u7684\u65b9\u6cd5\u3002\u4e0b\u9762\u662f super \u8c03\u7528\u7684\u5b9e\u73b0</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">objc_msgSendSuper</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"cm\">/* struct objc_super *super, SEL op, ... */</span><span class=\"w\"> </span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"c1\">// Specifies the superclass of an instance. </span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">objc_super</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"c1\">// Specifies an instance of a class.</span>\n<span class=\"w\">  </span><span class=\"n\">__unsafe_unretained</span><span class=\"w\"> </span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">receiver</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"c1\">// Specifies the particular superclass of the instance to message. </span>\n<span class=\"w\">  </span><span class=\"cp\">#if !defined(__cplusplus)  &amp;&amp;  !__OBJC2__</span>\n<span class=\"w\">  </span><span class=\"cm\">/* For compatibility with old objc-runtime.h header */</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">__unsafe_unretained</span><span class=\"w\"> </span><span class=\"kt\">Class</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"cp\">#else</span>\n<span class=\"w\">  </span><span class=\"n\">__unsafe_unretained</span><span class=\"w\"> </span><span class=\"kt\">Class</span><span class=\"w\"> </span><span class=\"n\">super_class</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"cp\">#endif</span>\n<span class=\"w\">  </span><span class=\"cm\">/* super_class is the first class to search */</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"cp\">#endif</span>\n</code></pre></div>\n\n<p>\u9519\u89c9\u5728\u4e8e\u6211\u4eec\u4ee5\u4e3a\u6700\u7ec8\u662f super_class-&gt;class \u65b9\u6cd5\uff0c\u7136\u800c\u5728 objc_super \u7ed3\u6784\u4f53\u4e2d super_class \u5e76\u975e\u662f\u6d88\u606f\u63a5\u6536\u8005\uff0creceiver \u624d\u662f\u63a5\u6536\u8005\uff0c\u6839\u636e\u6ce8\u91ca\u6211\u4eec\u53ef\u4ee5\u77e5\u9053 receiver \u5176\u5b9e\u5c31\u662f self\uff0c\u6240\u4ee5\u6700\u7ec8\u6d88\u606f\u53d1\u9001\u662f\u8fd9\u6837\u7684</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">objc_msgSend</span><span class=\"p\">(</span><span class=\"n\">objc_super</span><span class=\"o\">-&gt;</span><span class=\"n\">receiver</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">@selector</span><span class=\"p\">(</span><span class=\"k\">class</span><span class=\"p\">))</span><span class=\"w\"></span>\n</code></pre></div>\n\n<h4 id=\"_3\">\u6d88\u606f\u8f6c\u53d1</h4>\n<p>\u5728\u7ee7\u627f\u6811\u4e0a\u627e\u4e0d\u5230\u65b9\u6cd5\u5b9e\u73b0\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u4f1a\u5c06\u6d88\u606f\u8f6c\u53d1\u7ed9\u4e88\u63a5\u6536\u8005\u6700\u540e\u4e09\u6b21\u673a\u4f1a\u53bb\u5904\u7406\uff0c\u5982\u679c\u8fd8\u662f\u672a\u5904\u7406\u4fbf\u4f1a\u6267\u884c doesNotRecognizeSelector: \u65b9\u6cd5\u65b9\u6cd5\u7ec8\u6b62\u7a0b\u5e8f\uff0c\u62a5 unrecognized selector \u9519\u8bef\u3002</p>\n<p>\u6d88\u606f\u8f6c\u53d1\u5206\u4e3a\u4e24\u5927\u9636\u6bb5\uff0c\u7b2c\u4e00\u9636\u6bb5\u5148\u5f81\u8be2\u63a5\u6536\u8005\uff0c\u6240\u5c5e\u7684\u7c7b\u662f\u5426\u80fd\u52a8\u6001\u6dfb\u52a0\u65b9\u6cd5\u4ee5\u5904\u7406\u6b64\u672a\u77e5\u6d88\u606f\u3002\u7b2c\u4e8c\u9636\u6bb5\u6d89\u53ca \u201c\u5b8c\u6574\u7684\u6d88\u606f\u8f6c\u53d1\u673a\u5236\u201d\uff0c\u5728\u6b64\u9636\u6bb5\u65e0\u6cd5\u4f7f\u7528\u52a8\u6001\u6dfb\u52a0\u65b9\u6cd5\u6765\u5904\u7406\u672a\u77e5\u6d88\u606f\u3002\u6b64\u65f6\uff0cruntime \u4f1a\u8bf7\u6c42\u63a5\u6536\u8005\u4ee5\u5176\u4ed6\u624b\u6bb5\u6765\u5904\u7406\u4e0e\u6d88\u606f\u76f8\u5173\u7684\u65b9\u6cd5\u8c03\u7528\u3002\u8fd9\u91cc\u7ec6\u5206\u4e3a\u4e24\u5c0f\u6b65\uff0c\u9996\u5148\uff0c\u8bf7\u63a5\u6536\u8005\u770b\u770b\u662f\u5426\u6709\u5176\u4ed6\u5bf9\u8c61\u80fd\u591f\u5904\u7406\u8fd9\u6761\u6d88\u606f\u3002\u82e5\u6709\u5219\u5c06\u6d88\u606f\u8f6c\u53d1\u7ed9\u8be5\u5bf9\u8c61\u5904\u7406\uff0c\u6d88\u606f\u8f6c\u53d1\u7ed3\u675f\u3002\u82e5\u6ca1\u6709\u201c\u5907\u63f4\u7684\u63a5\u6536\u8005\u201d\uff0c\u5219\u542f\u52a8\u5b8c\u6574\u7684\u6d88\u606f\u8f6c\u53d1\u673a\u5236\uff0cruntime\u4f1a\u5c06\u6d88\u606f\u6709\u5173\u7684\u5168\u90e8\u7ec6\u8282\u90fd\u5c01\u88c5\u5230 NSInvocation \u4e2d\uff0c\u518d\u7ed9\u63a5\u6536\u8005\u6700\u540e\u4e00\u6b21\u673a\u4f1a\u53bb\u8bbe\u6cd5\u89e3\u51b3\u3002</p>\n<h5 id=\"_4\">\u52a8\u6001\u65b9\u6cd5\u89e3\u6790</h5>\n<p>\u5728\u76f4\u81f3 NSObject \u8fd8\u6ca1\u627e\u5230\u65b9\u6cd5\u5b9e\u73b0\u65f6\uff0c\u82e5\u672a\u77e5\u6d88\u606f\u662f\u5b9e\u4f8b\u65b9\u6cd5\u4fbf\u4f1a\u8c03\u7528 -resolveInstanceMethod: \u82e5\u672a\u77e5\u6d88\u606f\u662f\u7c7b\u65b9\u6cd5\u4fbf\u4f1a\u8c03\u7528 +resolveClassMethod: \uff0c\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u7c7b\u4f3c\uff0c\u90fd\u662f\u63d0\u4f9b\u673a\u4f1a\uff0c\u52a8\u6001\u6dfb\u52a0\u4e00\u4e2a\u5904\u7406\u8be5\u6d88\u606f\u7684\u65b9\u6cd5\u3002</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"c1\">// \u4f7f\u7528 runtime \u9700\u5bfc\u5165 runtime\u5e93\uff0cmessage.h \u5305\u542b\u4e86 objc.h \u548c runtime.h</span>\n<span class=\"cp\">#import &lt;objc/message.h&gt;</span>\n\n<span class=\"c1\">// \u88ab\u6dfb\u52a0\u7684\u65b9\u6cd5</span>\n<span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">add_method</span><span class=\"p\">(</span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"nb\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">SEL</span><span class=\"w\"> </span><span class=\"n\">_cmd</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n\n\n<span class=\"p\">+</span> <span class=\"p\">(</span><span class=\"kt\">BOOL</span><span class=\"p\">)</span><span class=\"nf\">resolveInstanceMethod:</span><span class=\"p\">(</span><span class=\"kt\">SEL</span><span class=\"p\">)</span><span class=\"nv\">sel</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">sel</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"k\">@selector</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">// \u6dfb\u52a0 add_method \u4f5c\u4e3a method \u7684\u65b9\u6cd5\u5b9e\u73b0</span>\n<span class=\"w\">    </span><span class=\"n\">class_addMethod</span><span class=\"p\">([</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">sel</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">IMP</span><span class=\"p\">)</span><span class=\"n\">add_method</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">&quot;v@:&quot;</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">YES</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">super</span><span class=\"w\"> </span><span class=\"n\">resolveInstanceMethod</span><span class=\"o\">:</span><span class=\"n\">sel</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<h5 id=\"_5\">\u5907\u63f4\u63a5\u6536\u8005</h5>\n<p>\u5982\u63a5\u6536\u8005\u672a\u80fd\u52a8\u6001\u6dfb\u52a0\u65b9\u6cd5\u53bb\u5904\u7406\u6d88\u606f\uff0c\u90a3\u4e48\u4e0b\u4e00\u6b65\u4fbf\u4f1a\u5bfb\u627e\u80fd\u5904\u7406\u8be5\u6d88\u606f\u7684\u63a5\u6536\u8005\u3002\u8be5\u6b65\u9aa4\u7684\u5904\u7406\u65b9\u6cd5\u4e3a -forwardingTargetForSelector: \uff0c\u53ef\u4ee5\u5728\u6b64\u65b9\u6cd5\u4e2d\u6839\u636e\u65b9\u6cd5\u6765\u9009\u7528\u5907\u63f4\u63a5\u6536\u8005\u3002</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">id</span><span class=\"p\">)</span><span class=\"nf\">forwardingTargetForSelector:</span><span class=\"p\">(</span><span class=\"kt\">SEL</span><span class=\"p\">)</span><span class=\"nv\">selector</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">selector</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"k\">@selector</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">//\u8fd4\u56de\u5907\u63f4\u63a5\u6536\u8005\u53bb\u63a5\u6536\u8fd9\u4e2a\u6d88\u606f</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">OtherObj</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">super</span><span class=\"w\"> </span><span class=\"n\">forwardingTargetForSelector</span><span class=\"o\">:</span><span class=\"n\">selector</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u6b64\u65b9\u6cd5\u5904\u7406\uff0c\u5728\u5916\u90e8\u770b\uff0c\u6d88\u606f\u4f3c\u4e4e\u662f\u7531\u5bf9\u8c61\u81ea\u5df1\u5904\u7406\u7684\uff0c\u8fd9\u4e00\u73b0\u8c61\u4e0e\u7ee7\u627f\u7c7b\u4f3c\uff0c\u5b50\u7c7b\u8c03\u7528\u81ea\u5df1\u672a\u5b9e\u73b0\u800c\u7236\u7c7b\u5b9e\u73b0\u4e86\u7684\u65b9\u6cd5\uff0c\u56e0\u6b64\u53ef\u7528\u6765\u6a21\u62df \u201c\u591a\u7ee7\u627f\u201d \u7279\u6027\u3002</p>\n<h5 id=\"_6\">\u5b8c\u6574\u7684\u6d88\u606f\u8f6c\u53d1</h5>\n<p>\u5982\u679c\u6ca1\u6709\u5907\u63f4\u63a5\u6536\u8005\uff0c\u90a3\u4e48\u552f\u4e00\u80fd\u505a\u7684\u4fbf\u662f\u542f\u7528\u5b8c\u6574\u7684\u6d88\u606f\u8f6c\u53d1\u673a\u5236\u3002\u9996\u5148\u901a\u8fc7 -methodSignatureForSelector: \u83b7\u53d6\u6d88\u606f\u65b9\u6cd5\u7684\u7ec6\u8282(\u5373\u65b9\u6cd5\u53c2\u6570\u3001\u8fd4\u56de\u7c7b\u578b\u7b49)\uff0c\u5c01\u88c5\u6210\u4e00\u4e2a NSMethodSignature(\u7b7e\u540d) \u5bf9\u8c61\uff0c\u5982\u679c\u83b7\u53d6\u6d88\u606f\u65b9\u6cd5\u5931\u8d25\uff0c\u4fbf\u8fd4\u56denil\uff0c\u8fd9\u65f6\u4fbf\u4f1a\u6267\u884c doesNotRecognizeSelector: \u65b9\u6cd5\u7ec8\u6b62\u7a0b\u5e8f\uff0c\u62a5 unrecognized selector \u9519\u8bef\u3002</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"bp\">NSMethodSignature</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nf\">methodSignatureForSelector:</span><span class=\"p\">(</span><span class=\"kt\">SEL</span><span class=\"p\">)</span><span class=\"nv\">selector</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">([</span><span class=\"n\">NSStringFromSelector</span><span class=\"p\">(</span><span class=\"n\">selector</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">isEqualToString</span><span class=\"o\">:</span><span class=\"s\">@&quot;method&quot;</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"bp\">NSMethodSignature</span><span class=\"w\"> </span><span class=\"n\">signatureWithObjCTypes</span><span class=\"o\">:</span><span class=\"s\">&quot;v@:&quot;</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">super</span><span class=\"w\"> </span><span class=\"n\">methodSignatureForSelector</span><span class=\"o\">:</span><span class=\"n\">selector</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>-methodSignatureForSelector: \u4e2d\u751f\u6210NSMethodSignature(\u7b7e\u540d)\u5bf9\u8c61\u540e\uff0c\u4fbf\u7528\u6b64\u7b7e\u540d\u5bf9\u8c61\u751f\u6210 NSInvocation \u5bf9\u8c61\u5e76\u901a\u8fc7 -forwardInvocation: \u65b9\u6cd5\u53d1\u7ed9\u76ee\u6807\u5bf9\u8c61\uff0c<br />\n\u5728\u6b64\u65b9\u6cd5\u4e2d\u8fd8\u6709\u6700\u540e\u4e00\u6b21\u673a\u4f1a\u53bb\u5904\u7406\u672a\u77e5\u6d88\u606f\u3002</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"p\">)</span><span class=\"nf\">forwardInvocation:</span><span class=\"p\">(</span><span class=\"bp\">NSInvocation</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">invocation</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"kt\">SEL</span><span class=\"w\"> </span><span class=\"n\">sel</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"p\">.</span><span class=\"n\">selector</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">OtherObj</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">OtherObj</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"p\">([</span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">respondsToSelector</span><span class=\"o\">:</span><span class=\"n\">sel</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">invocation</span><span class=\"w\"> </span><span class=\"n\">invokeWithTarget</span><span class=\"o\">:</span><span class=\"n\">obj</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"p\">[</span><span class=\"nb\">super</span><span class=\"w\"> </span><span class=\"n\">forwardInvocation</span><span class=\"o\">:</span><span class=\"n\">invocation</span><span class=\"p\">];;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u5982\u679c\u6ca1\u6709\u5728\u6b64\u65b9\u6cd5\u5904\u7406\u672a\u77e5\u6d88\u606f\u7684\u8bdd\uff0cruntime \u4f1a\u5c06\u6d88\u606f\u8f6c\u53d1\u7ed9\u7236\u7c7b\u5904\u7406\uff0c\u76f4\u81f3 NSObject \u6839\u7c7b\u90fd\u4e0d\u80fd\u5904\u7406\u7684\u8bdd\uff0c\u4fbf\u4f1a\u6267\u884c doesNotRecognizeSelector: \u65b9\u6cd5\u7ec8\u6b62\u7a0b\u5e8f\uff0c\u62a5 unrecognized selector \u9519\u8bef\u3002</p>\n<p><img alt=\"\" src=\"http://r.photo.store.qq.com/psb?/V11AuUlP0teFMG/uK1ivvVobqWkC3xNa9It0ew*ZA2g6kxhK8dq6P1cZuE!/r/dLYAAAAAAAAA\" /></p>\n<h3 id=\"runtime_1\">Runtime \u5e94\u7528</h3>\n<h4 id=\"_7\">\u5b9e\u73b0\u201c\u591a\u7ee7\u627f\u201d\u7279\u6027</h4>\n<p>\u5728\u6d88\u606f\u7684\u8f6c\u53d1\u7684\u7b2c\u4e09\u6b65\u7684\u5bfb\u627e\u5907\u63f4\u63a5\u6536\u8005\u4e2d\uff0c\u5bf9\u8c61\u8c03\u7528\u672a\u5b9e\u73b0\u7684\u65b9\u6cd5\uff0c\u5728 forwardingTargetForSelector: \u4e2d\u8fd4\u56de\u5907\u7528\u63a5\u53d7\u8005\u53bb\u8c03\u7528\u8be5\u65b9\u6cd5\uff0c\u5728\u8868\u9762\u5c31\u50cf\u662f\u5bf9\u8c61\u81ea\u5df1\u8c03\u7528\u7684\uff0c\u8fd9\u5c31\u50cf\u5b50\u7c7b\u8c03\u7528\u81ea\u5df1\u672a\u5b9e\u73b0\u800c\u7236\u7c7b\u5b9e\u73b0\u4e86\u7684\u65b9\u6cd5\u3002</p>\n<p>\u5373\u4f7f\u6211\u4eec\u5229\u7528\u8f6c\u53d1\u6d88\u606f\u6765\u5b9e\u73b0\u4e86\u201c\u5047\u201d\u7ee7\u627f\uff0c\u4f46\u662fNSObject\u7c7b\u8fd8\u662f\u4f1a\u5c06\u4e24\u8005\u533a\u5206\u5f00\u3002\u50cfrespondsToSelector:\u548c isKindOfClass:\u8fd9\u7c7b\u65b9\u6cd5\u53ea\u4f1a\u8003\u8651\u7ee7\u627f\u4f53\u7cfb\uff0c\u4e0d\u4f1a\u8003\u8651\u8f6c\u53d1\u94fe\u3002</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kt\">BOOL</span><span class=\"w\"> </span><span class=\"n\">result1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">objc</span><span class=\"w\"> </span><span class=\"n\">respondsToSelector</span><span class=\"o\">:</span><span class=\"k\">@selector</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"p\">)];</span><span class=\"w\"></span>\n<span class=\"kt\">BOOL</span><span class=\"w\"> </span><span class=\"n\">result2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">otherObj</span><span class=\"w\"> </span><span class=\"n\">respondsToSelector</span><span class=\"o\">:</span><span class=\"k\">@selector</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"p\">)];</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>result1 \u4e3aNO, result2 \u4e3a YES\uff0c\u56e0\u4e3aobjc\u4e2d\u6ca1\u6709\u8be5\u65b9\u6cd5\u7684\u5b9e\u73b0\uff0c\u4e5f\u5e76\u4e0d\u662f objc \u8c03\u7528\u7684\uff0c\u800c\u662f\u5907\u63f4\u63a5\u6536\u8005 otherObj\u3002</p>\n<p>\u56e0\u6b64\u5982\u679c\u975e\u8981\u5236\u9020\u5047\u8c61\uff0c\u53cd\u5e94\u51fa\u8fd9\u79cd\u201c\u5047\u201d\u7684\u7ee7\u627f\u5173\u7cfb\uff0c\u90a3\u4e48\u9700\u8981\u91cd\u65b0\u5b9e\u73b0 respondsToSelector:\u548c isKindOfClass:\u3002</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">BOOL</span><span class=\"p\">)</span><span class=\"nf\">respondsToSelector:</span><span class=\"p\">(</span><span class=\"kt\">SEL</span><span class=\"p\">)</span><span class=\"nv\">selector</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">([</span><span class=\"nb\">super</span><span class=\"w\"> </span><span class=\"n\">respondsToSelector</span><span class=\"o\">:</span><span class=\"n\">selector</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">YES</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">// \u5728\u6b64\u5c06\u5224\u65ad\u5bf9\u8c61\u53d8\u6210\u5047\u7ee7\u627f\u6765\u6e90\u5bf9\u8c61</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">([</span><span class=\"n\">otherObj</span><span class=\"w\"> </span><span class=\"n\">respondsToSelector</span><span class=\"o\">:</span><span class=\"n\">selector</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">      </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">YES</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">NO</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u9664\u4e86respondsToSelector:\u548c isKindOfClass:\u4e4b\u5916\uff0cinstancesRespondToSelector: \u4e2d\u4e5f\u5e94\u8be5\u5199\u4e00\u4efd\u8f6c\u53d1\u7b97\u6cd5\u3002\u5982\u679c\u4f7f\u7528\u4e86\u534f\u8bae\uff0cconformsToProtocol: \u4e5f\u4e00\u6837\u9700\u8981\u91cd\u5199\u3002\u7c7b\u4f3c\u5730\uff0c\u5982\u679c\u4e00\u4e2a\u5bf9\u8c61\u8f6c\u53d1\u5b83\u63a5\u53d7\u7684\u4efb\u4f55\u8fdc\u7a0b\u6d88\u606f\uff0c\u5b83\u5f97\u7ed9\u51fa\u4e00\u4e2a methodSignatureForSelector: \u6765\u8fd4\u56de\u51c6\u786e\u7684\u65b9\u6cd5\u63cf\u8ff0\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u4f1a\u6700\u7ec8\u54cd\u5e94\u88ab\u8f6c\u53d1\u7684\u6d88\u606f\u3002\u6bd4\u5982\u4e00\u4e2a\u5bf9\u8c61\u80fd\u7ed9\u5b83\u7684\u66ff\u4ee3\u8005\u5bf9\u8c61\u8f6c\u53d1\u6d88\u606f\uff0c\u5b83\u9700\u8981\u50cf\u4e0b\u9762\u8fd9\u6837\u5b9e\u73b0 methodSignatureForSelector:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"bp\">NSMethodSignature</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nf\">methodSignatureForSelector:</span><span class=\"p\">(</span><span class=\"kt\">SEL</span><span class=\"p\">)</span><span class=\"nv\">selector</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"bp\">NSMethodSignature</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">signature</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">super</span><span class=\"w\"> </span><span class=\"n\">methodSignatureForSelector</span><span class=\"o\">:</span><span class=\"n\">selector</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">signature</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"n\">signature</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">otherObj</span><span class=\"w\"> </span><span class=\"n\">methodSignatureForSelector</span><span class=\"o\">:</span><span class=\"n\">selector</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">signature</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u9700\u8981\u5f15\u8d77\u6ce8\u610f\u7684\u4e00\u70b9\uff0c\u5b9e\u73b0methodSignatureForSelector\u65b9\u6cd5\u662f\u4e00\u79cd\u5148\u8fdb\u7684\u6280\u672f\uff0c\u53ea\u9002\u7528\u4e8e\u6ca1\u6709\u5176\u4ed6\u89e3\u51b3\u65b9\u6848\u7684\u60c5\u51b5\u4e0b\u3002\u5b83\u4e0d\u4f1a\u4f5c\u4e3a\u7ee7\u627f\u7684\u66ff\u4ee3\u3002\u5982\u679c\u5fc5\u987b\u4f7f\u7528\u8fd9\u79cd\u6280\u672f\uff0c\u8bf7\u786e\u4fdd\u5b8c\u5168\u7406\u89e3\u7c7b\u505a\u7684\u8f6c\u53d1\u548c\u8f6c\u53d1\u7684\u7c7b\u7684\u884c\u4e3a\u3002\u8bf7\u52ff\u6ee5\u7528\uff01</p>\n<h4 id=\"method-swizzling\">Method Swizzling \u65b9\u6cd5\u4ea4\u6362</h4>\n<p>Method Swizzing\u662f\u53d1\u751f\u5728\u8fd0\u884c\u65f6\u7684\uff0c\u7528\u4e8e\u5728\u8fd0\u884c\u65f6\u5c06\u4e24\u4e2aMethod\u7684 IMP \u548c SEL \u8fdb\u884c\u4ea4\u6362\uff0c\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e00\u7279\u6027\u6765\u5b9e\u73b0 AOP \u7f16\u7a0b\u3002\u65b9\u6cd5\u4ea4\u6362\u5b9e\u73b0\u5982\u4e0b\uff1a</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"cp\">#import &lt;objc/runtime.h&gt;</span>\n\n\n<span class=\"p\">+</span> <span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"p\">)</span><span class=\"nf\">load</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">dispatch_once_t</span><span class=\"w\"> </span><span class=\"n\">onceToken</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">dispatch_once</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">onceToken</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">^</span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kt\">Class</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kt\">SEL</span><span class=\"w\"> </span><span class=\"n\">originalSelector</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">@selector</span><span class=\"p\">(</span><span class=\"n\">viewWillAppear</span><span class=\"o\">:</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kt\">SEL</span><span class=\"w\"> </span><span class=\"n\">swizzledSelector</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">@selector</span><span class=\"p\">(</span><span class=\"n\">xxx_viewWillAppear</span><span class=\"o\">:</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"n\">Method</span><span class=\"w\"> </span><span class=\"n\">originalMethod</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">class_getInstanceMethod</span><span class=\"p\">(</span><span class=\"k\">class</span><span class=\"p\">,</span><span class=\"n\">originalSelector</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">Method</span><span class=\"w\"> </span><span class=\"n\">swizzledMethod</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">class_getInstanceMethod</span><span class=\"p\">(</span><span class=\"k\">class</span><span class=\"p\">,</span><span class=\"n\">swizzledSelector</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">//judge the method named  swizzledMethod is already existed.</span>\n<span class=\"w\">    </span><span class=\"kt\">BOOL</span><span class=\"w\"> </span><span class=\"n\">didAddMethod</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">class_addMethod</span><span class=\"p\">(</span><span class=\"k\">class</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">originalSelector</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">method_getImplementation</span><span class=\"p\">(</span><span class=\"n\">swizzledMethod</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">method_getTypeEncoding</span><span class=\"p\">(</span><span class=\"n\">swizzledMethod</span><span class=\"p\">));</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">// if swizzledMethod is already existed.</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">didAddMethod</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">class_replaceMethod</span><span class=\"p\">(</span><span class=\"k\">class</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">swizzledSelector</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">method_getImplementation</span><span class=\"p\">(</span><span class=\"n\">originalMethod</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">method_getTypeEncoding</span><span class=\"p\">(</span><span class=\"n\">originalMethod</span><span class=\"p\">));</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"n\">method_exchangeImplementations</span><span class=\"p\">(</span><span class=\"n\">originalMethod</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">swizzledMethod</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">});</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>+load \u4f1a\u5728\u7c7b\u521d\u59cb\u52a0\u8f7d\u65f6\u8c03\u7528\uff0c\u8fd8\u6709\u4e00\u4e2a +initialize \u65b9\u6cd5\uff0c\u4f46\u662f +initialize\u65b9\u6cd5\u662f\u61d2\u52a0\u8f7d\u8c03\u7528\u7684\uff0c\u6240\u4ee5\u4f60\u53ef\u80fd\u6ca1\u6709\u673a\u4f1a\u8c03\u7528\uff0c\u56e0\u6b64\u6211\u4eec\u5e94\u5c06 swizzling \u7684\u4ee3\u7801\u5728 +load \u8c03\u7528\u3002</p>\n<p>\u5728 +load \u65b9\u6cd5\u8c03\u7528\u6267\u884c swizzling \u4ee3\u7801\u540e\uff0c\u65b9\u6cd5\u624d\u4f1a\u4ea4\u6362\u751f\u6548\uff0c\u5982\u679c\u518d\u6b21\u8c03\u7528\u4fbf\u4f1a\u518d\u6b21\u4ea4\u6362\u53d8\u6210\u539f\u72b6 xxx_viewWillAppear \u7684 imp\u5b9e\u73b0\u4f9d\u7136\u662f xxx_viewWillAppear IMP\uff0c\u56e0\u6b64\u4ea4\u6362\u65b9\u6cd5\u7684\u4ee3\u7801\u53ea\u5e94\u8c03\u7528\u4e00\u6b21\uff0c\u6240\u4ee5\u6211\u4eec\u5e94\u5c06 swizzling \u7684\u4ee3\u7801\u5728 dispatch_once \u4e2d\u6267\u884c\uff0c\u8bf7\u6ce8\u610f\u4e0d\u8981\u8c03\u7528 [super load] \uff0c\u56e0\u4e3a\u5982\u679c\u7236\u7c7b\u4e5f Swizzling \u540c\u4e00\u4e2a\u65b9\u6cd5\u7684 \u4ee3\u7801\uff0c\u7236\u7c7b\u7684Swizzling\u5c31\u5931\u6548\u4e86\u3002</p>\n<h4 id=\"aop\">AOP \u9762\u5411\u5207\u9762</h4>\n<blockquote>\n<p>\u53ef\u4ee5\u901a\u8fc7\u9884\u7f16\u8bd1\u65b9\u5f0f\u548c\u8fd0\u884c\u671f\u52a8\u6001\u4ee3\u7406\u5b9e\u73b0\u5728\u4e0d\u4fee\u6539\u6e90\u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\u7ed9\u7a0b\u5e8f\u52a8\u6001\u7edf\u4e00\u6dfb\u52a0\u529f\u80fd\u7684\u4e00\u79cd\u6280\u672f\u3002<br />\n\u53ef\u4ee5\u5bf9\u4e1a\u52a1\u903b\u8f91\u7684\u5404\u4e2a\u90e8\u5206\u8fdb\u884c\u9694\u79bb\uff0c\u4ece\u800c\u4f7f\u5f97\u4e1a\u52a1\u903b\u8f91\u5404\u90e8\u5206\u4e4b\u95f4\u7684\u8026\u5408\u5ea6\u964d\u4f4e\uff0c\u63d0\u9ad8\u7a0b\u5e8f\u7684\u53ef\u91cd\u7528\u6027\uff0c\u540c\u65f6\u63d0\u9ad8\u4e86\u5f00\u53d1\u7684\u6548\u7387\u3002</p>\n</blockquote>\n<p>\u6bd4\u5982\u50cf \u8eab\u4efd\u63a7\u5236\u3001\u8bb0\u5f55\u65e5\u5fd7\u8fd9\u4e9b\u4e8b\u52a1\u4e0d\u5c5e\u4e8e\u4efb\u4f55\u4e00\u6a21\u5757\u5e76\u4e14\u53c8\u5f88\u96be\u62bd\u8c61\u51fa\u4e00\u4e2a\u6a21\u5757\uff0c\u4f46\u662f\u5404\u6a21\u5757\u90fd\u4f7f\u7528\u4e86\uff0c\u8fd9\u7c7b\u4e8b\u52a1\u5c31\u50cf\u4e00\u4e2a\u7eb5\u5411\u5207\u9762\uff0c\u6d89\u53ca\u8bb8\u591a\u7c7b\u3001\u7c7b\u65b9\u6cd5\u3002</p>\n<p>AOP \u7684\u591a\u6570\u64cd\u4f5c\u662f\u5728 -forwardInvocation: \u4e2d\u5b8c\u6210\u7684\uff0c\u4e00\u822c\u4f1a\u5206\u4e3a2\u4e2a\u9636\u6bb5\uff0c\u4e00\u4e2a\u662f\u65b9\u6cd5\u6ce8\u518c\uff0c\u4e00\u4e2a\u662f\u65b9\u6cd5\u8c03\u7528\u3002</p>\n<p>\u9996\u5148\u4f1a\u628a\u7c7b\u91cc\u9762\u7684\u67d0\u4e2a\u8981\u5207\u7247\u7684\u65b9\u6cd5\u7684 IMP \u52a0\u5165\u5230 Aspect \u4e2d\uff0c\u7c7b\u65b9\u6cd5\u91cc\u9762\u5982\u679c\u6709 -forwardingTargetForSelector: \u65b9\u6cd5\u7684IMP\uff0c\u4e5f\u8981\u52a0\u5165\u5230 Aspect \u4e2d\uff0c\u7136\u540e\u5bf9\u7c7b\u8981\u5207\u7247\u7684\u65b9\u6cd5\u548c -forwardingTargetForSelector: \u65b9\u6cd5\u7684 IMP \u8fdb\u884c\u66ff\u6362\uff0c\u8981\u5207\u7247\u7684\u65b9\u6cd5\u7684 IMP \u66ff\u6362\u4e3a objc_msgForward() \uff08\u6d88\u606f\u8f6c\u53d1\u51fd\u6570\uff09\u7684 IMP\uff0c\u8fd9\u6837\u65b9\u6cd5\u90fd\u6ce8\u518c\u5b8c\u4e86\u3002</p>\n<p>\u5f53\u6267\u884c\u65b9\u6cd5\u7684\u65f6\u5019\uff0c\u4f1a\u53bb\u67e5\u627e\u5b83\u7684IMP\uff0c\u627e\u5230\u7684 IMP \u65b9\u6cd5\u662f objc_msgForward() \u7684 IMP \uff0c\u8fdb\u5165\u6d88\u606f\u8f6c\u53d1\uff0c\u7531\u4e8e\u672a\u52a8\u6001\u6dfb\u52a0\u65b9\u6cd5\uff0c\u4e8e\u662f\u5f00\u59cb\u67e5\u627e\u5907\u63f4\u63a5\u6536\u5bf9\u8c61\u3002<br />\n\u67e5\u627e\u5907\u63f4\u63a5\u53d7\u8005\u8c03\u7528 -forwardingTargetForSelector: \u8fd9\u4e2a\u65b9\u6cd5\uff0c\u7531\u4e8e\u6b64\u65b9\u6cd5 hook \u8fc7\u4e86\uff0cIMP \u6307\u5411\u7684\u662f hook \u8fc7\u7684 -forwardingTargetForSelector: \u65b9\u6cd5\u3002\u5728 hook \u8fc7\u7684 -forwardingTargetForSelector: \u65b9\u6cd5\u4e2d\u8bbe\u7f6e\u8fd4\u56de Aspect  \u4f5c\u4e3a\u5907\u63f4\u63a5\u53d7\u8005\u3002</p>\n<p>\u6709\u4e86 Aspect \u4f5c\u4e3a\u5907\u63f4\u63a5\u53d7\u8005\u4e4b\u540e\uff0c\u5c31\u4f1a\u91cd\u65b0 objc_msgSend\uff0c\u4ece\u6d88\u606f\u53d1\u9001\u9636\u6bb5\u91cd\u5934\u5f00\u59cb\u3002<br />\nobjc_msgSend \u627e\u4e0d\u5230\u6307\u5b9a\u7684IMP\uff0c\u518d\u8fdb\u884c -class_resolveMethod\uff0c\u8fd9\u91cc\u4e5f\u6ca1\u6709\u627e\u5230\uff0cforwardingTargetForSelector:\u8fd9\u91cc\u4e5f\u4e0d\u505a\u5904\u7406\uff0c\u63a5\u7740\u5c31\u4f1amethodSignatureForSelector\u3002\u5728methodSignatureForSelector\u65b9\u6cd5\u4e2d\u521b\u5efa\u4e00\u4e2aNSInvocation\u5bf9\u8c61\uff0c\u4f20\u9012\u7ed9 Aspect \u7684 -forwardInvocation \u65b9\u6cd5\u3002</p>\n<p>Aspect \u91cc\u9762\u7684 -forwardInvocation: \u65b9\u6cd5\u4f1a\u5e72\u6240\u6709\u5207\u9762\u7684\u4e8b\u60c5\uff0c\u8fd9\u91cc\u65b9\u6cd5\u8c03\u7528\u5c31\u5b8c\u5168\u7531\u6211\u4eec\u81ea\u5b9a\u4e49\u4e86\u3002\u6ce8\u518c\u65b9\u6cd5\u7684\u65f6\u5019\u6211\u4eec\u4e5f\u52a0\u5165\u4e86\u539f\u6765\u65b9\u6cd5\u4e2d\u7684 method() \u548c -forwardingTargetForSelector: \u65b9\u6cd5\u7684IMP\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u5728forwardInvocation\u65b9\u6cd5\u4e2d\u53bb\u6267\u884c\u8fd9\u4e9b IMP\u3002\u5728\u6267\u884c\u8fd9\u4e9b IMP \u7684\u524d\u540e\u90fd\u53ef\u4ee5\u4efb\u610f\u7684\u63d2\u5165\u4efb\u4f55 IMP \u4ee5\u8fbe\u5230\u5207\u9762\u7684\u76ee\u7684\u3002</p>\n<h4 id=\"kvo\">KVO \u89c2\u5bdf\u8005</h4>\n<blockquote>\n<p>KVO \u662f\u901a\u8fc7\u4e00\u79cd\u53eb\u505ais a-swizzling\u7684\u6280\u672f\u5b9e\u73b0\u7684\uff0cisa\u6307\u9488\u6307\u5411\u7ef4\u62a4\u5206\u6d3e\u8868\u7684\u5bf9\u8c61\u7684\u7c7b\u3002\u8fd9\u4e2a\u5206\u6d3e\u8868\u5b9e\u8d28\u4e0a\u5305\u542b\u6307\u5411\u7c7b\u5b9e\u73b0\u7684\u65b9\u6cd5\u7684\u6307\u9488\u4ee5\u53ca\u5176\u4ed6\u6570\u636e\u3002\u5f53\u4e00\u4e2a\u89c2\u5bdf\u8005\u4e3a\u4e00\u4e2a\u5bf9\u8c61\u7684\u5c5e\u6027\u6ce8\u518c\u65f6\uff0c\u89c2\u5bdf\u5bf9\u8c61\u7684 isa \u6307\u9488\u88ab\u4fee\u6539\uff0c\u6307\u5411\u4e00\u4e2a\u4e2d\u95f4\u7c7b\u800c\u4e0d\u662f\u771f\u6b63\u7684\u7c7b\u3002\u56e0\u6b64\uff0cisa\u6307\u9488\u7684\u503c\u4e0d\u4e00\u5b9a\u53cd\u6620\u5b9e\u4f8b\u7684\u5b9e\u9645\u7c7b\uff0c\u4e0d\u5e94\u8be5\u4f9d\u8d56isa\u6307\u9488\u6765\u786e\u5b9a\u7c7b\u6210\u5458\u3002\u76f8\u53cd\uff0c\u5e94\u8be5\u4f7f\u7528\u7c7b\u65b9\u6cd5\u6765\u786e\u5b9a\u5bf9\u8c61\u5b9e\u4f8b\u7684\u7c7b\u3002</p>\n</blockquote>\n<p>\u5728\u5c5e\u6027\u503c\u53d1\u751f\u53d8\u5316\u7684\u65f6\u5019\uff0c\u80af\u5b9a\u4f1a\u8c03\u7528\u5176 setter \u65b9\u6cd5\u3002\u56e0\u6b64\uff0cKVO\u7684\u672c\u8d28\u5c31\u662f\u76d1\u542c\u5bf9\u8c61\u6709\u6ca1\u6709\u8c03\u7528\u88ab\u76d1\u542c\u5c5e\u6027\u5bf9\u5e94\u7684 setter \u65b9\u6cd5\u3002\u5177\u4f53\u65b9\u6cd5\u5e94\u662f\u9700\u8981\u91cd\u5199 setter \u65b9\u6cd5\uff0c\u5982\u4f55\u91cd\u5199\u7684\uff1f\u5b9e\u9a8c\u5982\u4e0b\uff1a</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[[</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">alloc</span><span class=\"p\">]</span><span class=\"n\">init</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"p\">[</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">addObserver</span><span class=\"o\">:</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">forKeyPath</span><span class=\"o\">:</span><span class=\"s\">@&quot;name&quot;</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"o\">:</span><span class=\"n\">NSKeyValueObservingOptionNew</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"o\">:</span><span class=\"nb\">nil</span><span class=\"p\">];</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u6253\u5370\u89c2\u5bdfisa\u6307\u9488\u7684\u6307\u5411</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"c1\">// a \u6ce8\u518c KVO \u76d1\u542c\u524d</span>\n<span class=\"n\">NSLog</span><span class=\"p\">(</span><span class=\"s\">@&quot;Printing description of a-&gt;isa = %@&quot;</span><span class=\"p\">,</span><span class=\"n\">ClassMethodNames</span><span class=\"p\">(</span><span class=\"n\">object_getClass</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">)));</span><span class=\"w\"></span>\n\n<span class=\"n\">Printing</span><span class=\"w\"> </span><span class=\"n\">description</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">-&gt;</span><span class=\"n\">isa</span><span class=\"o\">:</span><span class=\"w\"></span>\n<span class=\"n\">A</span><span class=\"w\"></span>\n\n<span class=\"c1\">// a \u6ce8\u518c KVO \u76d1\u542c\u540e</span>\n<span class=\"n\">NSLog</span><span class=\"p\">(</span><span class=\"s\">@&quot;Printing description of a-&gt;isa = %@&quot;</span><span class=\"p\">,</span><span class=\"n\">ClassMethodNames</span><span class=\"p\">(</span><span class=\"n\">object_getClass</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">)));</span><span class=\"w\"></span>\n\n<span class=\"n\">Printing</span><span class=\"w\"> </span><span class=\"n\">description</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">-&gt;</span><span class=\"n\">isa</span><span class=\"o\">:</span><span class=\"w\"></span>\n<span class=\"n\">NSKVONotifying_A</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u88ab\u89c2\u5bdf\u5bf9\u8c61\u7684 isa \u6307\u9488\u4ece\u6307\u5411\u539f\u6765\u7684 A \u7c7b\uff0c\u88abKVO \u673a\u5236\u4fee\u6539\u4e3a\u6307\u5411\u7cfb\u7edf\u65b0\u521b\u5efa\u7684\u5b50\u7c7b NSKVONotifying_A \u7c7b\uff0c\u6765\u5b9e\u73b0\u5f53\u524d\u7c7b\u5c5e\u6027\u503c\u6539\u53d8\u7684\u76d1\u542c\uff1b<br />\n\u6240\u4ee5\u5f53\u6211\u4eec\u4ece\u5e94\u7528\u5c42\u9762\u4e0a\u770b\u6765\uff0c\u5b8c\u5168\u6ca1\u6709\u610f\u8bc6\u5230\u6709\u65b0\u7684\u7c7b\u51fa\u73b0\uff0c\u8fd9\u662f\u7cfb\u7edf\u201c\u9690\u7792\u201d\u4e86\u5bf9 KVO \u7684\u5e95\u5c42\u5b9e\u73b0\u8fc7\u7a0b\uff0c\u8ba9\u6211\u4eec\u8bef\u4ee5\u4e3a\u8fd8\u662f\u539f\u6765\u7684\u7c7b\u3002\u4f46\u662f\u6b64\u65f6\u5982\u679c\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u540d\u4e3a\u201c NSKVONotifying_A \u201d\u7684\u7c7b\uff0c\u5c31\u4f1a\u53d1\u73b0\u7cfb\u7edf\u8fd0\u884c\u5230\u6ce8\u518c KVO \u7684\u90a3\u6bb5\u4ee3\u7801\u65f6\u7a0b\u5e8f\u5c31\u4f1a\u62a5 \u201c KVO failed to allocate class pair for name NSKVONotifying_A, automatic key-value observing will not work for this class \u201d\uff0c\u56e0\u4e3a\u7cfb\u7edf\u5728\u6ce8\u518c\u76d1\u542c\u7684\u65f6\u5019\u4f1a\u52a8\u6001\u521b\u5efa\u4e86\u540d\u4e3a NSKVONotifying_A \u7684\u4e2d\u95f4\u7c7b\uff0c\u5e76\u628a isa \u6307\u9488\u6307\u5411\u8fd9\u4e2a\u4e2d\u95f4\u7c7b\uff0c\u4f46\u662f\u7531\u4e8e\u6211\u4eec\u521b\u5efa\u4e00\u4e2aNSKVONotifying_A \u7c7b\uff0c\u5bfc\u81f4\u7cfb\u7edf\u5728\u6ce8\u518c\u76d1\u542c\u7684\u65f6\u5019\u65e0\u6cd5\u518d\u521b\u5efa\u4e00\u4e2aNSKVONotifying_A \u3002</p>\n<p>\u5728\u65b0\u7684\u7c7b\u4e2d\u4f1a\u91cd\u5199\u5bf9\u5e94\u7684 setter \u65b9\u6cd5\uff0c\u662f\u4e3a\u4e86\u5728 setter\u65b9\u6cd5\u4e2d\u589e\u52a0\u53e6\u5916\u4e24\u4e2a\u65b9\u6cd5\u7684\u8c03\u7528\uff0c\u56de\u8c03\u503c\u7684\u66f4\u6539\u72b6\u6001\u3002</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"p\">)</span><span class=\"nf\">willChangeValueForKey:</span><span class=\"p\">(</span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">key</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"p\">)</span><span class=\"nf\">didChangeValueForKey:</span><span class=\"p\">(</span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">key</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"c1\">//</span>\n<span class=\"c1\">// \u503c\u6539\u53d8\u56de\u8c03\u65b9\u6cd5\uff0c-didChangeValueForKey:(NSString *)key \u4e2d\u8c03\u7528</span>\n<span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"p\">)</span><span class=\"nf\">observeValueForKeyPath:</span><span class=\"p\">(</span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">keyPath</span><span class=\"w\"></span>\n<span class=\"nl\">ofObject</span><span class=\"p\">:(</span><span class=\"kt\">id</span><span class=\"p\">)</span><span class=\"nv\">object</span><span class=\"w\"></span>\n<span class=\"nl\">change</span><span class=\"p\">:(</span><span class=\"bp\">NSDictionary</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">change</span><span class=\"w\"></span>\n<span class=\"nl\">context</span><span class=\"p\">:(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">context</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u5982\u679c\u8bbf\u95ee\u5c5e\u6027\u7528\u7684\u662f KVC\uff0c\u90a3\u4e48 runtime \u4f1a\u5728 -setValue:forKey \u4e2d\u8c03\u7528 -will/didChangeValueForKey: \u65b9\u6cd5\u3002</p>\n<h4 id=\"associated-object\">Associated Object \u5173\u8054\u5bf9\u8c61</h4>\n<p>\u6709\u65f6\u9700\u8981\u5728\u5bf9\u8c61\u4e2d\u5b58\u653e\u76f8\u5173\u4fe1\u606f(\u589e\u52a0\u5c5e\u6027)\u65f6\uff0c\u6211\u4eec\u4f1a\u4ece\u5bf9\u8c61\u6240\u5c5e\u7684\u7c7b\u4e2d\u7ee7\u627f\u4e00\u4e2a\u5b50\u7c7b\uff0c\u7136\u540e\u6539\u7528\u8be5\u5b50\u7c7b\u3002\u9664\u6b64\u5916\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u201c\u5173\u8054\u5bf9\u8c61\u201d\u5c06\u5bf9\u8c61\u5173\u8054\u5176\u4ed6\u5bf9\u8c61\uff0c\u5bf9\u8c61\u901a\u8fc7 \u201c\u952e\u201d \u6765\u533a\u5206\uff0c\u5b58\u50a8\u5bf9\u8c61\u503c\u65f6\uff0c\u53ef\u4ee5\u6307\u660e\u201c\u5b58\u50a8\u7b56\u7565\u201d\u7ef4\u62a4\u201c\u5185\u5b58\u7ba1\u7406\u8bed\u4e49\u201d\u3002</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">OBJC_ASSOCIATION_ASSIGH</span><span class=\"w\">   </span><span class=\"o\">=&gt;</span><span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"></span>\n<span class=\"n\">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span><span class=\"w\">  </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">nonatomic</span><span class=\"p\">,</span><span class=\"k\">retain</span><span class=\"w\"></span>\n<span class=\"n\">OBJC_ASSOCIATION_COPY_NONATOMIC</span><span class=\"w\">  </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">nonatomic</span><span class=\"p\">,</span><span class=\"k\">copy</span><span class=\"w\"></span>\n<span class=\"n\">OBJC_ASSOCIATION_RETAIN</span><span class=\"w\">  </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">retain</span><span class=\"w\"></span>\n<span class=\"n\">OBJC_ASSOCIATION_COPY</span><span class=\"w\">  </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">copy</span><span class=\"w\"></span>\n\n<span class=\"c1\">// \u5173\u8054\u5bf9\u8c61\u65b9\u6cd5</span>\n<span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">objc_setAssociatedObject</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"n\">key</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">objc_AssociationPolicy</span><span class=\"w\"> </span><span class=\"n\">policy</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"c1\">// \u6839\u636ekey\u83b7\u53d6\u5173\u8054\u5bf9\u8c61\u503c</span>\n<span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">objc_getAssociatedObject</span><span class=\"p\">(</span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"n\">key</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"c1\">// \u79fb\u9664\u5bf9\u8c61\u7684\u5168\u90e8\u5173\u8054\u5bf9\u8c61</span>\n<span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">objc_removeAssociatedObjects</span><span class=\"p\">(</span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>\u8fd9\u79cd\u65b9\u6cd5\u53ef\u4ee5\u4e3a\u5df2\u6709\u7c7b\u589e\u52a0\u5c5e\u6027</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"cp\">#import &quot;objc/runtime.h&quot;</span>\n\n<span class=\"k\">@interface</span> <span class=\"bp\">NSObject</span> <span class=\"nl\">(AssociatedObject)</span><span class=\"w\"></span>\n<span class=\"k\">@property</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">nonatomic</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">strong</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">associatedObject</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"k\">@end</span><span class=\"w\"></span>\n\n<span class=\"k\">@implementation</span> <span class=\"bp\">NSObject</span> <span class=\"nl\">(AssociatedObject)</span><span class=\"w\"></span>\n<span class=\"k\">@dynamic</span><span class=\"w\"> </span><span class=\"n\">associatedObject</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n\n<span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"p\">)</span><span class=\"nf\">setAssociatedObject:</span><span class=\"p\">(</span><span class=\"kt\">id</span><span class=\"p\">)</span><span class=\"nv\">object</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">objc_setAssociatedObject</span><span class=\"p\">(</span><span class=\"nb\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">@selector</span><span class=\"p\">(</span><span class=\"n\">associatedObject</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n\n<span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">id</span><span class=\"p\">)</span><span class=\"nf\">associatedObject</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">objc_getAssociatedObject</span><span class=\"p\">(</span><span class=\"nb\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">@selector</span><span class=\"p\">(</span><span class=\"n\">associatedObject</span><span class=\"p\">));</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<h4 id=\"class_addmethod\">class_addMethod \u52a8\u6001\u589e\u52a0\u65b9\u6cd5</h4>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">class_addMethod</span><span class=\"p\">(</span><span class=\"kt\">Class</span><span class=\"w\"> </span><span class=\"n\">cls</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">SEL</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">IMP</span><span class=\"w\"> </span><span class=\"n\">imp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">types</span><span class=\"p\">)</span><span class=\"w\"> </span>\n</code></pre></div>\n\n<ul>\n<li>cls \u5bf9\u8c61</li>\n<li>name \u8981\u6dfb\u52a0\u7684\u65b9\u6cd5\u540d</li>\n<li>imp \u8981\u6dfb\u52a0\u7684\u65b9\u6cd5\u5b9e\u73b0</li>\n<li>types \u65b9\u6cd5\u7c7b\u578b\u5b57\u7b26\u4e32\uff0c\u5982 \"v@:\" \u8868\u793a\u8fd4\u56de\u7c7b\u578b\u4e3a void \u65e0\u53c2\u6570\uff0c\"i@:\" \u8868\u793a\u8fd4\u56de\u7c7b\u578b\u4e3a int \u65e0\u53c2\u6570\uff0c\"i@:@\" \u8868\u793a\u8fd4\u56de\u7c7b\u578b\u4e3a int \u4e00\u4e2a\u53c2\u6570\u3002</li>\n</ul>\n<h4 id=\"nscoding\">NSCoding \u81ea\u52a8\u5f52\u6863\u548c\u81ea\u52a8\u89e3\u6863</h4>\n<p>\u5f53\u7c7b\u7684\u5c5e\u6027\u591a\u8d77\u6765\u65f6\uff0c\u624b\u5199\u5bf9\u5e94\u5c5e\u6027\u7684\u5f52\u6863\u548c\u89e3\u6863\u4ee3\u7801\u5c31\u591a\u8d77\u6765\u4e86\uff0c\u5e76\u4e14\u90fd\u662f\u4e00\u6837\u7684\u4ee3\u7801\u3002\u53ef\u4ee5\u7528 runtime \u53bb\u83b7\u53d6\u7c7b\u7684\u6240\u6709\u6210\u5458\u5c5e\u6027\uff0c\u904d\u5386\u5c5e\u6027\uff0c\u5229\u7528 KVC \u53bb\u5b8c\u6210\u5f52\u6863\u548c\u89e3\u6863\u3002</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"cp\">#import &lt;objc/message.h&gt;</span>\n\n\n<span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"p\">)</span><span class=\"nf\">encodeWithCoder:</span><span class=\"p\">(</span><span class=\"bp\">NSCoder</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">aCoder</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">outCount</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">Ivar</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">vars</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">class_copyIvarList</span><span class=\"p\">([</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">outCount</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">outCount</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"n\">Ivar</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vars</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ivar_getName</span><span class=\"p\">(</span><span class=\"n\">var</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"n\">stringWithUTF8String</span><span class=\"o\">:</span><span class=\"n\">name</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">valueForKey</span><span class=\"o\">:</span><span class=\"n\">key</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">aCoder</span><span class=\"w\"> </span><span class=\"n\">encodeObject</span><span class=\"o\">:</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">forKey</span><span class=\"o\">:</span><span class=\"n\">key</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n\n<span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">id</span><span class=\"p\">)</span><span class=\"nf\">initWithCoder:</span><span class=\"p\">(</span><span class=\"bp\">NSCoder</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">aDecoder</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nb\">super</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">outCount</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">Ivar</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">vars</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">class_copyIvarList</span><span class=\"p\">([</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">outCount</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">outCount</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">      </span><span class=\"n\">Ivar</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vars</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ivar_getName</span><span class=\"p\">(</span><span class=\"n\">var</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"n\">stringWithUTF8String</span><span class=\"o\">:</span><span class=\"n\">name</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">aDecoder</span><span class=\"w\"> </span><span class=\"n\">decodeObjectForKey</span><span class=\"o\">:</span><span class=\"n\">key</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"p\">[</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">setValue</span><span class=\"o\">:</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">forKey</span><span class=\"o\">:</span><span class=\"n\">key</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">self</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<h4 id=\"_8\">\u5b57\u5178\u548c\u6a21\u578b\u4e92\u76f8\u8f6c\u6362</h4>\n<h5 id=\"_9\">\u5b57\u5178\u8f6c\u6a21\u578b</h5>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"p\">)</span><span class=\"nf\">objectWithDictionary:</span><span class=\"p\">(</span><span class=\"bp\">NSDictionary</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nv\">dictionary</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">dictionary</span><span class=\"p\">.</span><span class=\"n\">allKeys</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"c1\">// 1. \u6839\u636ekey \u4ece dictionary\u4e2d\u83b7\u53d6\u503c</span>\n<span class=\"w\">    </span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">dictionary</span><span class=\"p\">[</span><span class=\"n\">key</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"c1\">// 2. \u6839\u636e key \u4ece\u6a21\u578b\u4e2d\u83b7\u53d6\u5c5e\u6027</span>\n<span class=\"w\">    </span><span class=\"n\">objc_property_t</span><span class=\"w\"> </span><span class=\"n\">property</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">class_getProperty</span><span class=\"p\">([</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"p\">.</span><span class=\"n\">UTF8String</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"c1\">// 3. \u83b7\u53d6\u5c5e\u6027\u7684\u7c7b\u578b\uff0c\u7528\u4e8e\u5904\u7406\u4e8c\u7ea7\u5d4c\u5957\uff0c\u6b64\u5904\u672a\u5904\u7406\u3002</span>\n<span class=\"w\">    </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">outCount</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">objc_property_attribute_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">attributeList</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">property_copyAttributeList</span><span class=\"p\">(</span><span class=\"n\">property</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">outCount</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">objc_property_attribute_t</span><span class=\"w\"> </span><span class=\"n\">attribute</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">attributeList</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">typeString</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"n\">stringWithUTF8String</span><span class=\"o\">:</span><span class=\"n\">attribute</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">];</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">// 4. \u751f\u6210 setter \u65b9\u6cd5\uff0c\u4f7f\u7528 objc_msgSend \u8c03\u7528\u751f\u6210\u7684 setter \u65b9\u6cd5\uff0c\u6216\u8005\u7528 KVC\uff0c\u8bbe\u7f6e\u5c5e\u6027\u7684\u503c</span>\n<span class=\"w\">    </span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">methodName</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"n\">stringWithFormat</span><span class=\"o\">:</span><span class=\"s\">@&quot;set%@%@:&quot;</span><span class=\"p\">,[</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"n\">substringToIndex</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"p\">].</span><span class=\"n\">uppercaseString</span><span class=\"p\">,[</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"n\">substringFromIndex</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"p\">]];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kt\">SEL</span><span class=\"w\"> </span><span class=\"k\">setter</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">sel_registerName</span><span class=\"p\">(</span><span class=\"n\">methodName</span><span class=\"p\">.</span><span class=\"n\">UTF8String</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">([</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">respondsToSelector</span><span class=\"o\">:</span><span class=\"k\">setter</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">      </span><span class=\"p\">((</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">id</span><span class=\"p\">,</span><span class=\"kt\">SEL</span><span class=\"p\">,</span><span class=\"kt\">id</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"n\">objc_msgSend</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nb\">self</span><span class=\"p\">,</span><span class=\"k\">setter</span><span class=\"p\">,</span><span class=\"n\">value</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">attributeList</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<h5 id=\"_10\">\u6a21\u578b\u8f6c\u5b57\u5178</h5>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"p\">-</span> <span class=\"p\">(</span><span class=\"bp\">NSDictionary</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"nf\">keyValuesWithObject</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"c1\">// 1. \u83b7\u53d6\u5c5e\u6027\u5217\u8868</span>\n<span class=\"w\">  </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">outCount</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">objc_property_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">propertyList</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">class_copyPropertyList</span><span class=\"p\">([</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">outCount</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"bp\">NSMutableDictionary</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">dict</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"bp\">NSMutableDictionary</span><span class=\"w\"> </span><span class=\"n\">dictionary</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"c1\">// 2. \u904d\u5386\u5c5e\u6027\u5217\u8868</span>\n<span class=\"w\">  </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">outCount</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">// 3. \u751f\u6210getter\u65b9\u6cd5\uff0c\u5e76\u7528objc_msgSend\u8c03\u7528</span>\n<span class=\"w\">    </span><span class=\"n\">objc_property_t</span><span class=\"w\"> </span><span class=\"n\">property</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">propertyList</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">propertyName</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">property_getName</span><span class=\"p\">(</span><span class=\"n\">property</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kt\">SEL</span><span class=\"w\"> </span><span class=\"k\">getter</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">sel_registerName</span><span class=\"p\">(</span><span class=\"n\">propertyName</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">([</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"n\">respondsToSelector</span><span class=\"o\">:</span><span class=\"k\">getter</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"kt\">id</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">id</span><span class=\"p\">,</span><span class=\"kt\">SEL</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"n\">objc_msgSend</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nb\">self</span><span class=\"p\">,</span><span class=\"k\">getter</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">     </span><span class=\"c1\">// 4. \u5224\u65ad\u5f53\u524d\u5c5e\u6027\u662f\u4e0d\u662fModel</span>\n<span class=\"w\">     </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">([</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">isKindOfClass</span><span class=\"o\">:</span><span class=\"p\">[</span><span class=\"nb\">self</span><span class=\"w\"> </span><span class=\"k\">class</span><span class=\"p\">]]</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">keyValuesWithObject</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">     </span><span class=\"c1\">// 5. \u5b58\u5165\u5b57\u5178\u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528 objc_msgSend \u8c03\u7528\u751f\u6210\u7684 getter \u65b9\u6cd5\uff0c\u6216\u8005\u7528 KVC</span>\n<span class=\"w\">     </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n\n<span class=\"w\">        </span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"bp\">NSString</span><span class=\"w\"> </span><span class=\"n\">stringWithUTF8String</span><span class=\"o\">:</span><span class=\"n\">propertyName</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">[</span><span class=\"n\">dict</span><span class=\"w\"> </span><span class=\"n\">setObject</span><span class=\"o\">:</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">forKey</span><span class=\"o\">:</span><span class=\"n\">key</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">propertyList</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">dict</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n<h3 id=\"_11\">\u603b\u7ed3</h3>\n<p>Runtime \u80fd\u63d0\u4f9b\u5f88\u591a\u4fbf\u5229\u7684\u89e3\u51b3\u65b9\u6cd5\uff0c\u5982 Method swizzling \u80fd\u5feb\u901f\u5b9e\u73b0\u57cb\u70b9\u7edf\u8ba1\uff0c\u53ef\u4ee5\u7ed9\u5206\u7c7b\u6dfb\u52a0\u5c5e\u6027\u7b49\uff0c\u4f46\u662f\u8fd9\u7c7b\u5e94\u7528\u9700\u614e\u7528\uff0c\u56e0\u4f7f\u7528\u4e3aruntime \u9020\u6210\u7684 bug \u5f88\u96be\u5b9a\u4f4d\u3002\u56e0\u6b64\uff0c\u82e5\u5fc5\u987b\u4f7f\u7528\u9700\u8bb0\u5f55\u4f7f\u7528\u4e86 runtime \u7684\u5730\u65b9\uff0c\u4ee5\u4f9b\u65e5\u540e\u8c03\u8bd5\u4f7f\u7528 runtime \u9020\u6210\u7684 bug \u4f7f\u7528\uff0c\u6216\u8005\u4ea4\u63a5\u4ed6\u4eba\u5de5\u4f5c\u3002</p>\n<p>\u6574\u7406\u51fa\u5904:</p>\n<ul>\n<li><a href=\"https://www.jianshu.com/p/9d649ce6d0b8\">\u795e\u7ecf\u75c5\u9662Objective-C Runtime\u5165\u9662\u7b2c\u4e00\u5929\u2014\u2014isa\u548cClass</a></li>\n<li><a href=\"https://www.jianshu.com/p/4d619b097e20\">\u795e\u7ecf\u75c5\u9662Objective-C Runtime\u4f4f\u9662\u7b2c\u4e8c\u5929\u2014\u2014\u6d88\u606f\u53d1\u9001\u4e0e\u8f6c\u53d1</a></li>\n<li><a href=\"https://www.jianshu.com/p/db6dc23834e3\">\u795e\u7ecf\u75c5\u9662Objective-C Runtime\u51fa\u9662\u7b2c\u4e09\u5929\u2014\u2014\u5982\u4f55\u6b63\u786e\u4f7f\u7528Runtime</a></li>\n<li><a href=\"https://www.jianshu.com/p/6ebda3cd8052\">iOS Runtime\u8be6\u89e3</a></li>\n</ul>"}